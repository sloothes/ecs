<!DOCTYPE html>
<html lang="en">
	<head>

		<title>Legacy ECS Engine (pre-alpha 0.17)</title>

		<meta charset="utf-8">
		<meta name="generator" content="Three.js Editor">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<link rel="stylesheet" href="/css/joystick.css">
		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootbox-dialoges.css">
		<link rel="stylesheet" href="/css/jcrop.css">

		<script src="/js/watch.js"></script>
		<script src="/js/Objectid.js"></script>
		<script src="/js/jquery.min.js"></script> 
		<script src="/js/system.min.js"></script>
		<script src="/js/signals.min.js"></script>
		<script src="/js/inflate.min.js"></script>
		<script src="/js/zangodb.min.js"></script>
		<script src="/js/bootstrap.min.js"></script>
		<script src="/js/hold-event.min.js"></script>
		<script src="/js/jcrop.js"></script>

		<style>

			body {
				margin: 0px;
				font-size: 13px;
				font-family: sans-serif;
				background-repeat: repeat;
				background-image: url("https://i.imgur.com/rnZZU0i.png") !important;
				overflow: hidden;
			}

			#loading-bar {
				width:100%;
				height:100%;
				top:0; left:0;
				position:fixed;
				display:flex;
				align-items:center;
				justify-content:center;
			}

			.middle > * {
				top:0; 
				left:0;
				right:0;
				bottom:0;
				margin:auto;
				position:absolute;
			}

			#joystick1 {
				right: calc(40px + 370px);
			}
			
			#jumpButton {
				right: calc(105px + 370px);
			}

			.btn-matcap,
			.btn-terrain {
				padding:0;
				float:left;
				width:55px;
				height:55px;
				border:1px solid;
				border-radius:4px;
				margin-right:4px;
				margin-bottom:4px;
				display:inline-block;
			}

			.btn-matcap + .btn-matcap,
			.btn-terrain + .btn-terrain {
				margin-right:4px;
			}

		</style>
	</head>

	<body ontouchstart="">

		<script>

			debugMode = true;
			const Signal = signals.Signal;

		</script>

		<script src="/ecs/js/three.js"></script>
		<script src="/ecs/js/TabUI.js"></script>
		<script src="/ecs/js/MeshWalk.js"></script>
		<script src="/ecs/js/UVsDebug.js"></script>
		<script src="/ecs/js/FBXLoader.js"></script>
		<script src="/ecs/js/VirtualInput.js"></script>
		<script src="/ecs/js/KeyboardState.js"></script>
		<script src="/ecs/js/EditorControls.js"></script>
		<script src="/ecs/js/camera-controls.js"></script>
		<script src="/ecs/js/SubdivisionModifier.js"></script>
		<script src="/ecs/js/three-pathfinding.umd.js"></script>
		<script src="/threejs/r96/examples/js/loaders/GLTFLoader.js"></script>
		<script src="/threejs/r96/examples/js/exporters/GLTFExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/STLExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/OBJExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/ColladaExporter.js"></script>

		<script>

		//	TabUI.

			(function(){

				var sidePanel = createSidePanel();
				document.body.appendChild( sidePanel );

				var loginTab = TabUI.add( "Login", "login-tab" );
				var debugTab = TabUI.add( "Debug", "debug-tab" );
				var levelTab = TabUI.add( "Levels", "level-tab" );
				var editorTab = TabUI.add( "Editor", "editor-tab" );
				var cameraTab = TabUI.add( "Camera", "camera-tab" );
				var controlTab = TabUI.add( "Controls", "control-tab" );
				var playersTab = TabUI.add( "Players", "players-tab" );
				var textureTab = TabUI.add( "Texture", "texture-tab" );
				var geoemtryTab = TabUI.add( "Geometry", "geometry-tab" );
				var materialTab = TabUI.add( "Material", "material-tab" );
				var animationTab = TabUI.add( "Animations", "animation-tab" );

				TabUI.append("Editor", "Material", "Texture", "Geometry", "Controls", "Camera", "Players", "Animations", "Levels", "Debug" );
				TabUI.Material.role.classList.add("active");
				TabUI.Material.tab.classList.add("in","active");

			})();

		</script>

		<script src="/ecs/engine/core/enviroment.js"></script>
		<script src="/ecs/engine/core/entity.js"></script>
		<script src="/ecs/engine/core/helpers.js"></script>
		<script src="/ecs/engine/core/localPlayer.js"></script>
		<script src="/ecs/engine/core/cameraControls.js"></script>
		<script src="/ecs/engine/core/keyboardState.js"></script>
		<script src="/ecs/engine/core/keyInputControls.js"></script>
		<script src="/ecs/engine/core/joystickControls.js"></script>
		<script src="/ecs/engine/core/keyboard.js"></script>
		<script src="/ecs/engine/editor/EditorTab.js"></script>
		<script src="/ecs/engine/editor/MaterialTab.js"></script>
		<script src="/ecs/engine/editor/MaterialManager.js"></script>
	<!-- script src="/ecs/engine/editor/MaterialEditor.js"></script -->

		<script>
/*
		//	Material Tab.

		//	TabUI.append("Material");
		//	TabUI.Editor.role.classList.add("active");
		//	TabUI.Editor.tab.classList.add("in","active");

			const material_droplist = (function( tab ){

			//	Materials droplist.
			//	When option is selected, switches to EditMode.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "Entities:";
				row.style.cssText = "height:30px;"

				var select = document.createElement("select");
				select.id = "material-entities-droplist";
				select.style.cssText = "width:170px;color:#000;float:right;"
				+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
				+ "font-size:20px;margin-left:10px;margin-right:15px;";

				(function(){
					var option = document.createElement("option");
					option.value = "";
					select.appendChild( option );
				})();

				row.appendChild( select );
				tab.appendChild( row );

				return select;

			})( TabUI.Material.tab );

			(function( tab ){

			//	Material map droplist.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "texture:";
				row.style.cssText = "height:30px;"

				var select = document.createElement("select");
				select.id = "material-map-droplist";
				select.style.cssText = "width:170px;color:#000;float:right;"
				+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
				+ "font-size:20px;margin-left:10px;margin-right:15px;";

				var keys = ",";
				keys += "map,aoMap,envMap,lightMap,bumpMap,alphaMap,normalMap,specularMap,"
				keys += "gradientMap,emissiveMap,metalnessMap,roughnessMap,displacementMap";

				keys.split(",").forEach(function( name ){
					var option = document.createElement("option");
					option.text = name;
					option.value = name;
					select.appendChild( option );
				});

				row.appendChild( select );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Import map texture button.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.style.cssText = "display:none;height:40px;margin-bottom:20px;"

				var button = document.createElement("div");
				button.id = "material-map-import-button";
				button.textContent = "Import Texture";
				button.style.cssText = "width:295px;float:right;height:40px;font-size:large;margin-right:15px;";
				button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				var input = document.createElement("input");
				input.type = "file";
				input.id = "material-map-file-input";
				input.style.cssText = "display:none;";
				button.appendChild( input );

				row.appendChild( button );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Undo/Redo button.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.style.cssText = "height:40px;margin-bottom:20px;"

				var redo = document.createElement("div");
				redo.id = "material-redo-button";
				redo.textContent = "Redo";
				redo.style.cssText = "width:44%;float:left;height:40px;font-size:large;margin-right:15px;";
				redo.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				var undo = document.createElement("div");
				undo.id = "material-undo-button";
				undo.textContent = "Undo";
				undo.style.cssText = "width:44%;float:right;height:40px;font-size:large;margin-right:15px;";
				undo.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				row.appendChild( redo );
				row.appendChild( undo );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Param mode droplist.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "param:";
				row.style.cssText = "height:40px;"

				var select = document.createElement("select");
				select.id = "material-param-droplist";
				select.style.cssText = "width:170px;color:#000;float:right;"
				+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
				+ "font-size:20px;margin-left:10px;margin-right:15px;";

				var keys = "";
				keys += "name,type,uuid,side,opacity,alphaTest,transparent,premultipliedAlpha,";
				keys += "fog,lights,visible,overdraw,dithering,precision,colorWrite,flatShading,vertexColors,";
				keys += "blending,blendSrc,blendDst,blendEquation,blendSrcAlpha,blendDstAlpha,blendEquationAlpha,";
				keys += "depthFunc,depthTest,depthWrite,shadowSide,clipShadows,clipIntersection,";
				keys += "polygonOffset,polygonOffsetUnits,polygonOffsetFactor,";
				keys += "metalness,roughness,bumpScale,reflectivity,";
				keys += "refractionRatio,displacementBias,normalMapType,";
				keys += "aoMapIntensity,envMapIntensity,emissiveIntensity,lightMapIntensity,";
				keys += "wireframe,wireframeLinecap,wireframeLinejoin,wireframeLinewidth,";
				keys += "skinning,morphTargets,morphNormals,combine,shininess,";
				keys += "depthPacking,scale,gapSize,linecap,linejoin,linewidth,";
				keys += "dashSize,size,rotation,sizeAttenuation";

				keys.split(",").forEach(function( name ){
					var option = document.createElement("option");
					option.text = name;
					option.value = name;
					select.appendChild( option );
				});

				row.appendChild( select );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	param value.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "value:";
				row.style.cssText = "margin:10px 15px;height:30px;";

				var vect = document.createElement("div");
				vect.style.cssText = "width:170px;height:40px;float:right;";

				var prev = document.createElement("li");
				prev.id = "material-param-value-decrease";
				prev.innerHTML = "&#9668;";
				prev.style.display = "inline";
				prev.classList.add("btn","btn-primary","get-prev-btn","pull-left");

				var next = document.createElement("li");
				next.id = "material-param-value-increase";
				next.innerHTML = "&#9658;";
				next.style.display = "inline";
				next.classList.add("btn","btn-primary","get-next-btn","pull-right");

				var input = document.createElement("input");
				input.id = "material-param-value-input";
				input.setAttribute("placeholder", "v" );
				input.classList.add("form-control","text-center");
				input.style.cssText = "color:#000;border:none;display:inline;width:80px;"
				+ "margin:0px 5px;text-align:center;font-size:large;font-weigth:bold;background:none;";

				vect.appendChild(prev);
				vect.appendChild(input);
				vect.appendChild(next);
				row.appendChild(vect);
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Scale mode droplist.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "scale:";
				row.style.cssText = "height:40px;"

				var select = document.createElement("select");
				select.id = "material-scale-droplist";
				select.style.cssText = "width:170px;color:#000;float:right;"
				+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
				+ "font-size:20px;margin-left:10px;margin-right:15px;";

				var keys = "";
				keys += "normalScale,displacementScale";

				keys.split(",").forEach(function( name ){
					var option = document.createElement("option");
					option.text = name;
					option.value = name;
					select.appendChild( option );
				});

				row.appendChild( select );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	vector x.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "vect x:";
				row.style.cssText = "margin:10px 15px;height:40px;";

				var vect = document.createElement("div");
				vect.style.cssText = "width:170px;height:40px;float:right;";

				var prev = document.createElement("li");
				prev.id = "material-scale-x-decrease";
				prev.innerHTML = "&#9668;";
				prev.style.display = "inline";
				prev.classList.add("btn","btn-primary","get-prev-btn","pull-left");

				var next = document.createElement("li");
				next.id = "material-scale-x-increase";
				next.innerHTML = "&#9658;";
				next.style.display = "inline";
				next.classList.add("btn","btn-primary","get-next-btn","pull-right");

				var input = document.createElement("input");
				input.id = "material-scale-x-input";
				input.setAttribute("placeholder", "x" );
				input.classList.add("form-control","text-center");
				input.style.cssText = "color:#000;border:none;display:inline;width:80px;"
				+ "margin:0px 5px;text-align:center;font-size:large;font-weigth:bold;background:none;";

				vect.appendChild(prev);
				vect.appendChild(input);
				vect.appendChild(next);
				row.appendChild(vect);
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	vector y.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "vect y:";
				row.style.cssText = "margin:10px 15px;height:40px;";

				var vect = document.createElement("div");
				vect.style.cssText = "width:170px;height:40px;float:right;";

				var prev = document.createElement("li");
				prev.id = "material-scale-y-decrease";
				prev.innerHTML = "&#9668;";
				prev.style.display = "inline";
				prev.classList.add("btn","btn-primary","get-prev-btn","pull-left");

				var next = document.createElement("li");
				next.id = "material-scale-y-increase";
				next.innerHTML = "&#9658;";
				next.style.display = "inline";
				next.classList.add("btn","btn-primary","get-next-btn","pull-right");

				var input = document.createElement("input");
				input.id = "material-scale-y-input";
				input.setAttribute("placeholder", "y" );
				input.classList.add("form-control","text-center");
				input.style.cssText = "color:#000;border:none;display:inline;width:80px;"
				+ "margin:0px 5px;text-align:center;font-size:large;font-weigth:bold;background:none;";

				vect.appendChild(prev);
				vect.appendChild(input);
				vect.appendChild(next);
				row.appendChild(vect);
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Color mode droplist.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "color:";
				row.style.cssText = "height:40px;"

				var select = document.createElement("select");
				select.id = "material-color-droplist";
				select.style.cssText = "width:170px;color:#000;float:right;"
				+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
				+ "font-size:20px;margin-left:10px;margin-right:15px;";

				var keys = "";
				keys += "color,emissive,specular";

				keys.split(",").forEach(function( name ){
					var option = document.createElement("option");
					option.text = name;
					option.value = name;
					select.appendChild( option );
				});

				row.appendChild( select );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	color red (r).
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "red:";
				row.style.cssText = "margin:10px 15px;height:40px;";

				var vect = document.createElement("div");
				vect.style.cssText = "width:170px;height:40px;float:right;";

				var prev = document.createElement("li");
				prev.id = "material-color-r-decrease";
				prev.innerHTML = "&#9668;";
				prev.style.display = "inline";
				prev.classList.add("btn","btn-primary","get-prev-btn","pull-left");

				var next = document.createElement("li");
				next.id = "material-color-r-increase";
				next.innerHTML = "&#9658;";
				next.style.display = "inline";
				next.classList.add("btn","btn-primary","get-next-btn","pull-right");

				var input = document.createElement("input");
				input.id = "material-color-r-input";
				input.setAttribute("placeholder", "r" );
				input.classList.add("form-control","text-center");
				input.style.cssText = "color:#000;border:none;display:inline;width:80px;"
				+ "margin:0px 5px;text-align:center;font-size:large;font-weigth:bold;background:none;";

				vect.appendChild(prev);
				vect.appendChild(input);
				vect.appendChild(next);
				row.appendChild(vect);
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	color green (g).
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "green:";
				row.style.cssText = "margin:10px 15px;height:40px;";

				var vect = document.createElement("div");
				vect.style.cssText = "width:170px;height:40px;float:right;";

				var prev = document.createElement("li");
				prev.id = "material-color-g-decrease";
				prev.innerHTML = "&#9668;";
				prev.style.display = "inline";
				prev.classList.add("btn","btn-primary","get-prev-btn","pull-left");

				var next = document.createElement("li");
				next.id = "material-color-g-increase";
				next.innerHTML = "&#9658;";
				next.style.display = "inline";
				next.classList.add("btn","btn-primary","get-next-btn","pull-right");

				var input = document.createElement("input");
				input.id = "material-color-g-input";
				input.setAttribute("placeholder", "g" );
				input.classList.add("form-control","text-center");
				input.style.cssText = "color:#000;border:none;display:inline;width:80px;"
				+ "margin:0px 5px;text-align:center;font-size:large;font-weigth:bold;background:none;";

				vect.appendChild(prev);
				vect.appendChild(input);
				vect.appendChild(next);
				row.appendChild(vect);
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	color blue (b).
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "blue:";
				row.style.cssText = "margin:10px 15px;height:40px;";

				var vect = document.createElement("div");
				vect.style.cssText = "width:170px;height:40px;float:right;";

				var prev = document.createElement("li");
				prev.id = "material-color-b-decrease";
				prev.innerHTML = "&#9668;";
				prev.style.display = "inline";
				prev.classList.add("btn","btn-primary","get-prev-btn","pull-left");

				var next = document.createElement("li");
				next.id = "material-color-b-increase";
				next.innerHTML = "&#9658;";
				next.style.display = "inline";
				next.classList.add("btn","btn-primary","get-next-btn","pull-right");

				var input = document.createElement("input");
				input.id = "material-color-b-input";
				input.setAttribute("placeholder", "b" );
				input.classList.add("form-control","text-center");
				input.style.cssText = "color:#000;border:none;display:inline;width:80px;"
				+ "margin:0px 5px;text-align:center;font-size:large;font-weigth:bold;background:none;";

				vect.appendChild(prev);
				vect.appendChild(input);
				vect.appendChild(next);
				row.appendChild(vect);
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Clone material button.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.style.cssText = "height:40px;margin-bottom:20px;"

				var button = document.createElement("div");
				button.id = "material-clone-button";
				button.textContent = "Clone Material";
				button.style.cssText = "width:295px;float:right;height:40px;font-size:large;margin-right:15px;";
				button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				row.appendChild( button );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Exit edit mode button.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.style.cssText = "height:40px;margin-bottom:20px;"

				var button = document.createElement("div");
				button.id = "material-exit-mode";
				button.textContent = "Exit Edit Mode";
				button.style.cssText = "width:295px;float:right;height:40px;font-size:large;margin-right:15px;";
				button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				row.appendChild( button );
				tab.appendChild( row );

			})( TabUI.Material.tab );
*/
		</script>

		<script>
/*
			(function( tab ){

			//	Material Type droplist.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "Material:";
				row.style.cssText = "display:none;height:40px;margin-top:40px;"

				var select = document.createElement("select");
				select.id = "material-type-droplist";
				select.style.cssText = "width:170px;color:#000;float:right;"
				+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
				+ "font-size:20px;margin-left:10px;margin-right:15px;";

				(function(){

					var types = "";
					types += "MeshBasicMaterial,MeshStandardMaterial,MeshLambertMaterial,MeshPhongMaterial,"
					types += "MeshDepthMaterial,MeshNormalMaterial,MeshToonMaterial,MeshPhysicalMaterial,PointsMaterial,"
					types += "LineBasicMaterial,LineDashedMaterial,RawShaderMaterial,ShaderMaterial,ShadowMaterial,SpriteMaterial";

					types.split(",").forEach(function( name ){
						var option = document.createElement("option");
						option.text = name;
						option.value = name;
						select.appendChild( option );
					});

				})();

				select.value = "MeshStandardMaterial";
				row.appendChild( select );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Create material entity button.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.style.cssText = "display:none;height:40px;margin-bottom:20px;"

				var button = document.createElement("div");
				button.id = "create-material-button";
				button.textContent = "Create Material Entity";
				button.style.cssText = "width:295px;float:right;height:40px;font-size:large;margin-right:15px;";
				button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				row.appendChild( button );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Clone material button.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.style.cssText = "display:none;height:40px;margin-bottom:20px;"

				var button = document.createElement("div");
				button.id = "clone-material-button";
				button.textContent = "Clone Material Entity";
				button.style.cssText = "width:295px;float:right;height:40px;font-size:large;margin-right:15px;";
				button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				row.appendChild( button );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Remove material entity button.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.style.cssText = "display:none;height:40px;margin-bottom:20px;"

				var button = document.createElement("div");
				button.id = "remove-material-button";
				button.textContent = "Remove Material Entity";
				button.style.cssText = "width:295px;float:right;height:40px;font-size:large;margin-right:15px;";
				button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				row.appendChild( button );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function(){

				var interval;

				const entity_droplist = document.getElementById("material-entities-droplist");
				const material_droplist = document.getElementById("material-type-droplist");
				const create_material_button = document.getElementById("create-material-button");
				const clone_material_button = document.getElementById("clone-material-button");
				const remove_material_button = document.getElementById("remove-material-button");

			//	const entitySelect  = { value:entity_droplist.value };   // string.
			//	const materialType  = { value:material_droplist.value }; // string.

				function getMaterialByEntityId( value ){
					var id = parseInt( value );
					return material_entities.find( function( material ){
						return material.id === id;
					});
				}

				create_material_button.addEventListener( "click", function(){
					clearTimeout( interval );
					interval = setTimeout(function(){

					//	Get type.
						var type = material_droplist.value;
						if ( type === "" || type === undefined ) return;

					//	Init params based on type.
						switch (type) {
						//	case "PointsMaterial":
						//	case "SpriteMaterial":
						//	case "ShaderMaterial":
						//	case "ShadowMaterial":
						//	case "MeshToonMaterial":
						//	case "MeshBasicMaterial":
						//	case "MeshPhongMaterial":
						//	case "MeshDepthMaterial":
						//	case "MeshNormalMaterial":
						//	case "MeshLambertMaterial":
						//	case "MeshStandardMaterial":
						//	case "MeshPhysicalMaterial":
						//	case "RawShaderMaterial":
						//	case "LineBasicMaterial":
						//	case "LineDashedMaterial":
						//	break;
						}

					//	Create.
						var material = new THREE[ type ]();
						if ( material === undefined ) return;
					//	Name it.
						material.name = "mtl"+material.id;
					//	Add entity.
						material_entities.add( material );

					//	Enter edit mode.
						entity_droplist.value = material.id.toString();
						entity_droplist.dispatchEvent(new Event("change")); // important!

					}, 250);
				});

				clone_material_button.addEventListener( "click", function(){
					clearTimeout( interval );
					interval = setTimeout(function(){

						var id = parseInt( entitySelect.value );
						if ( id === NaN || id === undefined ) return;

						//	Get source.
						var source = getMaterialByEntityId( id );
						if ( !(source && source.isMaterial) ) return;

						//	Clone source.
						if ( source && source.isMaterial ) {
							//	clone.
							var material = material.clone();
							//	rename.
							material.name = source.name.replace(/:clone/g,"") + ":clone"; // TODO: better renameing.
							//	add entity.
							material_entities.add( material );
							//	update entity select value (switch editor target).
							entity_droplist.value = mesh.id.toString();
							entity_droplist.dispatchEvent(new Event("change")); // important!
						}

					}, 250);
				});

				remove_material_button.addEventListener( "click", function(){
					clearTimeout( interval );
					interval = setTimeout(function(){

						var id = parseInt( entity_droplist.value );
						if ( id === NaN || id === undefined ) return;

					//	Remove material.
						material_entities.remove( id );

					}, 250);
				});

			})();
*/
		</script>

		<script>
/*
		//	Material Manager Class.

		//	Material Manager: inherits (extends) Array class.
		//	sources: https://stackoverflow.com/questions/26700164/extending-array-with-es6-classes
		//	https://stackoverflow.com/questions/11337849/ways-to-extend-array-object-in-javascript

			function MaterialManager(){
				var array = new Array(0);
				Object.setPrototypeOf( array, MaterialManager.prototype );
				return array; // important!
			};

			MaterialManager.prototype = Object.create(Array.prototype);
			MaterialManager.prototype.move = function( entity, new_index ){

				var old_index = this.findIndex(function( item ){
					return item.id === entity.id;
				});

				if ( old_index < 0 ) return; // important!
				if ( old_index == new_index ) return;

				(function( arr, old_index, new_index ){

					if (new_index >= arr.length) {
						var k = new_index - arr.length + 1;
						while (k--) {
							arr.push(undefined);
						}
					}

					arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);

				})( this, old_index, new_index);

			};

			MaterialManager.prototype.add = function(){
			//	params: {object:Material} 

				if ( arguments.length < 1 ) return;

				var materials  = [];

			//	Get materials/ids.
				for ( var i in arguments ) {
					var param = arguments[i];
					if ( typeof param === "object" && param.isMaterial && param.id !== undefined )
						materials.push( param );  // meterial;
					else 
						continue;
				}

				if ( !materials.length ) return;
			//	console.log( "materials:", materials );

				var length = materials.length;
				for ( var j = 0; j < length; j++ ) {
					this.push( materials[j] );
				}

			//	var material_droplist = document.getElementById("material-entities-droplist");
			//	global const "material_droplist" is defined in MaterialTab.js;
				if ( !material_droplist ) return;

			//	Add options.
				while ( materials.length ) (function( material ){
					var str =  "", dot = ".", col = ":";
					var type = "object";
					var name = material.name || "mtl"+material.id;
					if ( material.type ) type = material.type;
					var option = document.createElement("option");
					option.text = str+material.id+dot+type+col+name;
					option.value = material.id;
					material_droplist.appendChild( option );
				})( materials.shift() );
			};

			MaterialManager.prototype.remove = function(){
			//	params: {number:entity.id} or {object:entity} 

				if ( arguments.length < 1 ) return;

			//	Get removed ids.
				var remove_ids = [];
				for ( var i in arguments ) {
					var param = arguments[i];
					if ( typeof param === "number" && param % 1 === 0 ) // integer. 
						remove_ids.unshift( param );    // remove_ids.push( param );
					else if ( typeof param === "object" && param.isMaterial && param.id !== undefined )
						remove_ids.unshift( param.id ); // remove_ids.push( param.id );
					else 
						continue;
				}

				if ( !remove_ids.length ) return;
			//	console.log( "remove_ids:", remove_ids );

				var length = remove_ids.length;
				for ( var j = 0; j < length; j++ ) {

					var _id = remove_ids[ j ];

				//	Find index.
					var index = this.findIndex(function( item ){
						return item.id === _id;
					});

					if ( index < 0 ) continue; // important!

					var removedItems = this.splice(index, 1);
				//	debugMode && console.log( removedItems );

					while ( removedItems.length ){
						var removed = removedItems.shift();
					//	debugMode && console.log( removed );
						removed_materials.push( removed );
					}
				}

			//	var material_droplist = document.getElementById("material-entities-droplist");
			//	global const "material_droplist" is defined in MaterialTab.js;
				if ( !material_droplist ) return;

			//	Remove options.
				while ( remove_ids.length ) (function( id ){
					var selector = "option[value='" + id.toString() + "']"; // console.log( selector );
					var option = material_droplist.querySelector( selector ); // console.log(  option  );
					option && option.remove();
				})( remove_ids.shift() );

			};

			MaterialManager.prototype.clear = function(){

				this.length = 0;

			};

		//	Create material managers.

			const material_entities = new MaterialManager(); // material entities array, important!.
			const removed_materials = new MaterialManager(); // material entities array, important!.
*/
		</script>

		<script>

		//	Material Editor.

		//	Create a Material to hold editor values.
			const materialEditor = (function( editor ){

			//	var k = 0;
				const undo = [], redo = [];

			//	Editor tab.
				const editorTabSelect = { value:"" };
				(function( selector ){
					TabUI.Editor.tab.querySelector(selector).addEventListener("change", function(){
						editorTabSelect.value = this.value;  // string.
					});
				})("select#entities-droplist");

			//	droplists.

				const entity_droplist = document.getElementById("material-entities-droplist");
				const texture_droplist = document.getElementById("material-map-droplist");
				const param_droplist = document.getElementById("material-param-droplist");
				const scale_droplist = document.getElementById("material-scale-droplist");
				const color_droplist = document.getElementById("material-color-droplist");
				const type_droplist = document.getElementById("material-type-droplist");

				const entitySelect  = { value:"" }; // string.
				const textureSelect = { value:"" }; // string.
				const paramSelect   = { value:"" }; // string.
				const scaleSelect   = { value:"" }; // string.
				const colorSelect   = { value:"" }; // string.
				const materialType  = { value:"" }; // string.

			//	buttons.

				const redo_button = document.getElementById("material-redo-button");
				const undo_button = document.getElementById("material-undo-button");
				const exit_edit_button = document.getElementById("material-exit-mode");
				const create_material_button = document.getElementById("create-material-button");
				const clone_material_button = document.getElementById("clone-material-button");
				const remove_material_button = document.getElementById("remove-material-button");

			//	param input buttons.

				const material_param_input = document.getElementById("material-param-value-input");
				const increase_param_v_button = document.getElementById("material-param-value-increase");
				const decrease_param_v_button = document.getElementById("material-param-value-decrease");

			//	scale input buttons.

				const material_scale_x_input = document.getElementById("material-scale-x-input");
				const material_scale_y_input = document.getElementById("material-scale-y-input");

				const increase_scale_x_button = document.getElementById("material-scale-x-increase");
				const increase_scale_y_button = document.getElementById("material-scale-y-increase");

				const decrease_scale_x_button = document.getElementById("material-scale-x-decrease");
				const decrease_scale_y_button = document.getElementById("material-scale-y-decrease");

			//	color input buttons.

				const material_color_r_input = document.getElementById("material-color-r-input");
				const material_color_g_input = document.getElementById("material-color-g-input");
				const material_color_b_input = document.getElementById("material-color-b-input");

				const increase_color_r_button = document.getElementById("material-color-r-increase");
				const increase_color_g_button = document.getElementById("material-color-g-increase");
				const increase_color_b_button = document.getElementById("material-color-b-increase");

				const decrease_color_r_button = document.getElementById("material-color-r-decrease");
				const decrease_color_g_button = document.getElementById("material-color-g-decrease");
				const decrease_color_b_button = document.getElementById("material-color-b-decrease");

			//	helpers.

				function getObjectByEntityId( value ){
					var id = parseInt( value );
					if ( id === NaN ) return;
					return scene.getObjectById( id );
				}

				function getMaterialByEntityId( value ){
					var id = parseInt( value );
					return material_entities.find( function( material ){
						return material.id === id;
					});
				}

			//	add to undo/redo.

				function addToUndo(){
					redo.length = 0; // important!
					var json = editor.toJSON();
					json && undo.unshift( json );
					debugMode && console.log( arguments.callee.name, 
						"undo:", undo.length, "redo:", redo.length );
				}

				function addToRedo(){
					var json = editor.toJSON();
					json && redo.unshift( json );
					debugMode && console.log( arguments.callee.name, 
						"undo:", undo.length, "redo:", redo.length );
				}

			//	reset input values.

				function resetParamInputValues(){ 
					material_param_input.value = ""; 
					return;
				}

				function resetScaleInputValues(){ 
					material_scale_x_input.value = "";
					material_scale_y_input.value = "";
					return;
				}

				function resetColorInputValues(){ 
					material_color_r_input.value = "";
					material_color_g_input.value = "";
					material_color_b_input.value = "";
					return;
				}

			//	update input values.

				function updateParamInputValues( key ){
					if ( editor[ key ] === undefined ) return resetParamInputValues();
					material_param_input.value = editor[ key ];
				}

				function updateScaleInputValues( key ){
					if ( editor[ key ] === undefined ) return resetScaleInputValues();
					material_scale_x_input.value = parseFloat( editor[ key ].x ).toFixed(2);
					material_scale_y_input.value = parseFloat( editor[ key ].y ).toFixed(2);
				}

				function updateColorInputValues( key ){
					if ( editor[ key ] === undefined ) return resetColorInputValues();
					material_color_r_input.value = parseInt( 255*editor[ key ].r ).toFixed(0);
					material_color_g_input.value = parseInt( 255*editor[ key ].g ).toFixed(0);
					material_color_b_input.value = parseInt( 255*editor[ key ].b ).toFixed(0);
				}

			//	display vector values.

				function displayVectorValues( value ){

					switch ( value ){
						case "color":
						case "emissive":
						case "specular":
							updateColorInputValues( value );
						break;

						case "normalScale":
						case "displacementScale":
							updateScaleInputValues( value );
						break;
						
						default:
							updateParamInputValues( value );
						break;
					}

				}

			//	reset select droplist values.

				function resetEntitySelectValue(){ 
					entitySelect.value = entity_droplist.value = ""; 
					entity_droplist.dispatchEvent( new Event("change") );
				}
				function resetTextureSelectValue(){ 
					textureSelect.value = texture_droplist.value = ""; 
					texture_droplist.dispatchEvent( new Event("change") );
				}
				function resetParamSelectValue(){ 
					paramSelect.value = param_droplist.value = ""; 
					param_droplist.dispatchEvent( new Event("change") );
				}
				function resetScaleSelectValue(){ 
					scaleSelect.value = scale_droplist.value = ""; 
					scale_droplist.dispatchEvent( new Event("change") );
				}
				function resetColorSelectValue(){ 
					colorSelect.value = color_droplist.value = ""; 
					color_droplist.dispatchEvent( new Event("change") );
				}
				function resetMaterialTypeValue(){ 
					materialType.value = type_droplist.value = ""; 
					type_droplist.dispatchEvent( new Event("change") );
				}

			//	update select droplist values.

				function updateEntitySelectValue( value ){ 
					if ( value === undefined ) {
						entitySelect.value = entity_droplist.value; 
					} else {
						entitySelect.value = entity_droplist.value = value;
						entity_droplist.dispatchEvent( new Event("change") );
					}
				}

				function updateTextureSelectValue( value ){ 
					if ( value === undefined ) {
						textureSelect.value = texture_droplist.value; 
					} else {
						textureSelect.value = texture_droplist.value = value;
						texture_droplist.dispatchEvent( new Event("change") );
					}
				}

				function updateParamSelectValue( value ){ 
					if ( value === undefined ) {
						paramSelect.value = param_droplist.value; 
					} else {
						paramSelect.value = param_droplist.value = value;
						param_droplist.dispatchEvent( new Event("change") );
					}
				}

				function updateScaleSelectValue( value ){ 
					if ( value === undefined ) {
						scaleSelect.value = scale_droplist.value; 
					} else {
						scaleSelect.value = scale_droplist.value = value;
						scale_droplist.dispatchEvent( new Event("change") );
					}
				}

				function updateColorSelectValue( value ){ 
					if ( value === undefined ) {
						colorSelect.value = color_droplist.value; 
					} else {
						colorSelect.value = color_droplist.value = value;
						color_droplist.dispatchEvent( new Event("change") );
					}
				}

				function updateMaterialTypeValue( value ){ 
					if ( value === undefined ) {
						materialType.value = type_droplist.value; 
					} else {
						materialType.value = type_droplist.value = value;
						type_droplist.dispatchEvent( new Event("change") );
					}
				}

			//	exit from edit mode.

				function exitFromEditMode(){
					editor.reset(); // important!
					resetEntitySelectValue();
					resetTextureSelectValue();
					resetParamSelectValue();
					resetScaleSelectValue();
					resetColorSelectValue();
					resetParamInputValues();
					resetColorInputValues();
					resetScaleInputValues();
					debugMode && console.log( arguments.callee.name, editor );
					return;
				}

			//	switch to edit mode.

				function switchToEditMode( value ){
					if ( !editor.update( value ) ) exitFromEditMode();
				}

			//	editor reset.

				(function(){

					editor.reset = function(){

						var source = new THREE.Material();
					//	editor.copy( source ); // DO NOT overwrite editor.copy();

					//	reset.

						var keys = "";
						keys += "color,emissive,specular,normalScale,displacementScale,";
						keys += "name,type,uuid,side,opacity,alphaTest,transparent,premultipliedAlpha,";
						keys += "fog,lights,visible,overdraw,dithering,precision,colorWrite,flatShading,vertexColors,";
						keys += "blending,blendSrc,blendDst,blendEquation,blendSrcAlpha,blendDstAlpha,blendEquationAlpha,";
						keys += "depthFunc,depthTest,depthWrite,shadowSide,clipShadows,clipIntersection,";
						keys += "polygonOffset,polygonOffsetUnits,polygonOffsetFactor,";
						keys += "map,aoMap,envMap,bumpMap,alphaMap,lightMap,normalMap,specularMap,";
						keys += "gradientMap,emissiveMap,metalnessMap,roughnessMap,displacementMap,";
						keys += "metalness,roughness,bumpScale,reflectivity,";
						keys += "refractionRatio,displacementBias,normalMapType,";
						keys += "aoMapIntensity,envMapIntensity,emissiveIntensity,lightMapIntensity,";
						keys += "wireframe,wireframeLinecap,wireframeLinejoin,wireframeLinewidth,";
						keys += "skinning,morphTargets,morphNormals,combine,shininess,";
						keys += "depthPacking,scale,gapSize,linecap,linejoin,linewidth,";
						keys += "dashSize,size,rotation,sizeAttenuation";


						keys.split(",").forEach(function( key ){
							switch ( key ){

								case "name":
									editor.name = "material editor";
								break;

								case "color":
									if ( editor[ key ] === undefined )
										editor[ key ] = new THREE.Color(1,1,1);
									else
										editor[ key ].setRGB(1,1,1);
								break;

								case "emissive":
								case "specular":
									if ( editor[ key ] === undefined )
										editor[ key ] = new THREE.Color(1,1,1);
									else
										editor[ key ].setRGB(0,0,0);
								break;

								case "normalScale":
								case "displacementScale":
									if ( editor[ key ] === undefined )
										editor[ key ] = new THREE.Vector2(1,1);
									else
										editor[ key ].set(1,1);
								break;

								default:
									editor[ key ] = source[ key ];
								break;

								case "clippingPlanes": {

									var srcPlanes = source.clippingPlanes,
										dstPlanes = null;

									if ( srcPlanes !== null ) {

										var n = srcPlanes.length;
										dstPlanes = new Array( n );

										for ( var i = 0; i !== n; ++ i )
											dstPlanes[ i ] = srcPlanes[ i ].clone();

									}

									editor.clippingPlanes = dstPlanes;

								} break;

								case "userData":
									editor.userData = JSON.parse( JSON.stringify( source.userData ) );
								break;

							}
						});

						undo.length = 0; redo.length = 0; // clear undo/redo.
						debugMode && console.log( "material editor reset:", editor );
					};

					editor.reset(); // important!

				})();

			//	editor copy (overwrite).

				editor.copy = function( material ){
					Object.keys( material ).filter( function( key ){
						return typeof material[ key ] != "function";
					}).forEach( function( key ){
						try {
							if ( typeof material[ key ] === "object" ) {
								for ( var k in material[ key ] ){
									editor[ key ][ k ] = material[ key ][ k ];
								}
							} else {
								editor[ key ] = material[ key ];
							}
						} catch(err){
						//	debugMode && console.warn(err);
						}
					});
				};

			//	editor update.

				editor.update = function( value ){

				//	Reset editor.
					editor.reset();

				//	Get new material.
					var material = getMaterialByEntityId( value ); 

					if ( !material ) {
						debugMode && console.log( false );
						return false; // important!
					}

				//	Copy material.
					material && editor.copy( material );

				//	Object.keys( material ).filter( function( key ){
				//		return typeof material[ key ] != "function";
				//	}).forEach( function( key ){
				//		try {
				//			if ( typeof material[ key ] === "object" ) {
				//				for ( var k in material[ key ] ){
				//					editor[ key ][ k ] = material[ key ][ k ];
				//				}
				//			} else {
				//				editor[ key ] = material[ key ];
				//			}
				//		} catch(err){
				//			debugMode && console.warn(err);
				//		}
				//	});

					editor.type = material.type; // important!
					editor.name = material.name; // important!
					editor.uuid = material.uuid; //	important!

				//	keep initial state.
					material && addToUndo();
					debugMode && console.log( "material editor updated:", editor );

					debugMode && console.log( true );
					return true; // important!
				};

			//	editor undo/redo.

				(function(){

					var interval;

					editor.undo = function(){ 

						if ( !undo.length ) return;

					//	Get undo json.
						var json = undo.shift();

						if ( !json ) return;

						debugMode && console.log( json ); // debug!

					//	Move json to redo.
						redo.unshift( json );

						clearTimeout( interval );
						interval = setTimeout( function(){

						//	Copy state (undo).
							var loader = new THREE.MaterialLoader();
							var material = loader.parse( json ); // problem - error!!!
							debugMode && console.log( material );
							editor.copy( material );

							debugMode && console.log( "undo:", 
							undo.length, "redo:", redo.length );

						}, 250);
					};

					editor.redo = function(){

						if ( !redo.length ) return;

					//	Get redo json.
						var json = redo.shift();

						if ( !json ) return;

						debugMode && console.log( json ); // debug!

					//	Move json to undo.
						undo.unshift( json );

						clearTimeout( interval );
						interval = setTimeout( function(){

						//	Copy state (redo).
							var loader = new THREE.MaterialLoader();
							var material = loader.parse( json ); // problem - error!!!
							debugMode && console.log( material );
						//	editor.copy( material );

							debugMode && console.log( "undo:", 
							undo.length, "redo:", redo.length );

						}, 250);
					};

				})();

			//	buttons.

				(function(){

					var interval;

					redo_button.addEventListener( "click", editor.redo );
					undo_button.addEventListener( "click", editor.undo );

					exit_edit_button.addEventListener( "click",  function(){
						clearTimeout( interval );
						interval = setTimeout(function(){
							resetEntitySelectValue(); // exit from edit mode.
						}, 250);
					});

				})();

			//	droplists.

				(function(){

				//	function onChangeSelectValue(){

					//	entity_droplist.blur();
					//	texture_droplist.blur();
					//	param_droplist.blur();
					//	scale_droplist.blur();
					//	color_droplist.blur();
					//	type_droplist.blur();

					//	updateEntitySelectValue();
					//	updateTextureSelectValue();
					//	updateParamSelectValue();
					//	updateScaleSelectValue();
					//	updateColorSelectValue();
					//	updateMaterialTypeValue();

				//	}

				//	entity_droplist.addEventListener("change", onChangeSelectValue );
				//	texture_droplist.addEventListener("change", onChangeSelectValue );
				//	param_droplist.addEventListener("change", onChangeSelectValue );
				//	scale_droplist.addEventListener("change", onChangeSelectValue );
				//	color_droplist.addEventListener("change", onChangeSelectValue );
				//	type_droplist.addEventListener("change", onChangeSelectValue );

				//	DO NOT USE exitFromEditMode(); stack overflow!
				//	DO NOT USE resetEntitySelectValue(); stack overflow!
				//	DO NOT USE updateEntitySelectValue(); stack overflow!

					function blur_droplists(){
						type_droplist.blur();
						param_droplist.blur();
						scale_droplist.blur();
						color_droplist.blur();
						entity_droplist.blur();
						texture_droplist.blur();
					};

					entity_droplist.addEventListener("change", function(){

						blur_droplists(); // important!

					//	update editor.

						entitySelect.value = entity_droplist.value; // update editor.

					//	reset texture/param/scale.

						paramSelect.value = param_droplist.value = ""; // reset.
						scaleSelect.value = scale_droplist.value = ""; // reset.
						textureSelect.value = texture_droplist.value = ""; // reset.

					//	update color.

						if ( entitySelect.value ) {

							if ( editor.color ) updateColorSelectValue("color");
							else if ( editor.emissive ) updateColorSelectValue("emissive");
							else if ( editor.specular ) updateColorSelectValue("specular");

						}

					});

					param_droplist.addEventListener("change", function(){

						blur_droplists(); // important!

						if ( entitySelect.value ) {

							var key = param_droplist.value;
						//	TODO: cases depended on texture droplist?

							if ( editor[ key ] !== undefined )
								paramSelect.value = param_droplist.value; // update.
							else
								paramSelect.value = param_droplist.value = ""; // reset.
						} 
						
						else paramSelect.value = param_droplist.value = ""; // reset.

					});

					texture_droplist.addEventListener("change", function(){

						blur_droplists(); // important!

					//	DO NOT USE resetTextureSelectValue(); stack overflow!
					//	DO NOT USE updateTextureSelectValue(); stack overflow!

						if ( entitySelect.value && texture_droplist.value ) {

							textureSelect.value = texture_droplist.value; // update.

							if ( textureSelect.value === "normalMap"
							&& editor.normalMap && editor.normalScale ) {
								updateScaleSelectValue( "normalScale" ); // update.
							} 
						
							else if ( textureSelect.value === "displacementMap"
							&& editor.displacementMap && editor.displacementScale ) {
								updateScaleSelectValue( "displacementScale" ); // update.
							} 

							else scaleSelect.value = scale_droplist.value = ""; // reset.

						} else {

							scaleSelect.value = scale_droplist.value = "";     // reset.
							textureSelect.value = texture_droplist.value = ""; // reset.
						}
					});

					scale_droplist.addEventListener("change", function(){

						blur_droplists(); // important!

					//	DO NOT USE resetScaleSelectValue(); stack overflow!
					//	DO NOT USE updateScaleSelectValue(); stack overflow!

						if ( entitySelect.value && textureSelect.value && ( 
							( textureSelect.value === "normalMap" && editor.normalMap && editor.normalScale ) ||
							( textureSelect.value === "displacementMap" && editor.displacementMap && editor.displacementScale ) 
						) ) 
							scaleSelect.value = scale_droplist.value; // update.
						else 
							scaleSelect.value = scale_droplist.value = ""; // reset.
					});

					color_droplist.addEventListener("change", function(){

						blur_droplists(); // important!

					//	DO NOT USE resetColorSelectValue(); stack overflow!
					//	DO NOT USE updateColorSelectValue(); stack overflow!

						if ( entitySelect.value && ( 
							editor.color || editor.emissive || editor.specular 
						) )
							colorSelect.value = color_droplist.value; // update.
						else 
							colorSelect.value = color_droplist.value = ""; // reset.
					});


				})();

			//	scale inputs.

				(function(){

					var interval;

					const scale_x_input = document.getElementById("material-scale-x-input");
					const scale_y_input = document.getElementById("material-scale-y-input");

					const scale_x_increase = document.getElementById("material-scale-x-increase");
					const scale_y_increase = document.getElementById("material-scale-y-increase");
					const scale_x_decrease = document.getElementById("material-scale-x-decrease");
					const scale_y_decrease = document.getElementById("material-scale-y-decrease");

					function onInputChange(){

						var step = 1/100;
						this.blur(); // important!

						if ( !(entitySelect.value && scaleSelect.value) ) 

							return resetValues();

						if ( entitySelect.value && scaleSelect.value ) {

						//	Update.
							updateScale( this );

						//	Undo/Redo.
							addToUndo();

						}

						function resetValues(){

							if ( textureSelect.value !== "bumpMap" || textureSelect.value !== "displacementMap" ) {
								scale_x_input.value = scale_y_input.value = ""; return; // reset.
							} 

							if ( editor.bumpMap === undefined || editor.displacementMap === undefined ) {
								scale_x_input.value = scale_y_input.value = ""; return; // reset.
							} 

							if ( !scaleSelect.value ) {
								scale_x_input.value = scale_y_input.value = ""; return; // reset.
							} 

							var value = 1;
							scale_x_input.value = value.toFixed(2); // string.
							scale_y_input.value = value.toFixed(2); // string.

							return;
						}

						function displayValue( input ){

							if ( !input || !scaleSelect.value ) return resetValues();
							if ( editor.normalMap === undefined && editor.displacementMap === undefined ) return resetValues();
							if ( textureSelect.value !== "normalMap" && textureSelect.value !== "displacementMap" ) return resetValues();
							if ( scaleSelect.value !== "normalScale" && scaleSelect.value !== "displacementScale" ) return resetValues();

							var key = scaleSelect.value;

							if ( input === scale_x_input ) input.value = parseFloat( editor[ key ].x ).toFixed(2); // string.
							if ( input === scale_y_input ) input.value = parseFloat( editor[ key ].y ).toFixed(2); // string.

							return;
						}

						function updateScale( input ){

							if ( !input || !scaleSelect.value ) return resetValues();
							if ( editor.normalMap === undefined && editor.displacementMap === undefined ) return resetValues();
							if ( textureSelect.value !== "normalMap" && textureSelect.value !== "displacementMap" ) return resetValues();
							if ( scaleSelect.value !== "normalScale" && scaleSelect.value !== "displacementScale" ) return resetValues();

							var max = 10, min = -max;
							var key = scaleSelect.value;
							var value = THREE.Math.clamp( parseFloat( input.value ) % max, min, max );

							if ( input === scale_x_input ) editor[ key ].x = value; // update editor.
							if ( input === scale_y_input ) editor[ key ].y = value; // update editor.

							material.normalScale && editor.normalScale && material.normalScale.copy( editor.normalScale ); // update material.
							material.displacementScale && editor.displacementScale && material.displacementScale.copy( editor.displacementScale ); // update material.

							return displayValue( input );
						}

					}

					scale_x_input.addEventListener( "change", onInputChange );
					scale_y_input.addEventListener( "change", onInputChange );

					function onMouseClick(){

					//	clearTimeout( interval ); // important!

						if ( !scaleSelect.value ) return; // !editor.isEditing;
						if ( !entitySelect.value ) return; // !editor.isEditing;

						var material = getMaterialByEntityId( entitySelect.value );

						if ( !material ) return;
						if ( !material.normalMap && !material.displacementMap ) return;
						if ( !material.normalScale && !material.displacementScale ) return;

						if ( !editor.normalMap && !editor.displacementMap ) return;
						if ( !editor.normalScale && !editor.displacementScale ) return;

					//	Update editor.
						entitySelect.value && scaleSelect.value && updateScale( this ); // editor.isEditing, update editor.

					//	Update material.
						material.normalScale && editor.normalScale && material.normalScale.copy( editor.normalScale ); // update material.
						material.displacementScale && editor.displacementScale && material.displacementScale.copy( editor.displacementScale ); // update material.

					//	Undo/Redo.
						entitySelect.value && addToUndo();

						debugMode && console.log( "on Mouse Click:", interval );

					}

					function onMouseDown(){ 

						clearTimeout( interval ); // important!

						if ( !scaleSelect.value ) return; // !editor.isEditing;
						if ( !entitySelect.value ) return; // !editor.isEditing;

						var material = getMaterialByEntityId( entitySelect.value );

						if ( !material ) return;
						if ( !material.normalMap && !material.displacementMap ) return;
						if ( !material.normalScale && !material.displacementScale ) return;

						if ( !editor.normalMap && !editor.displacementMap ) return;
						if ( !editor.normalScale && !editor.displacementScale ) return;

						var button = this;
						var clock = new THREE.Clock();

						interval = setTimeout( function onUpdate() {

							if ( !material ) return;
							if ( !scaleSelect.value ) return;
							if ( !entitySelect.value ) return;

						//	Update editor.
							entitySelect.value && scaleSelect.value && updateScale( button ); // editor.isEditing, update editor.

						//	Update material.
							material.normalScale && editor.normalScale && material.normalScale.copy( editor.normalScale ); // update material.
							material.displacementScale && editor.displacementScale && material.displacementScale.copy( editor.displacementScale ); // update material.

							var dt = clock.getDelta();
							interval = setTimeout( onUpdate, dt );
						//	debugMode && console.log( "on Update:", interval );

						}, 500);
					}

					scale_x_increase.addEventListener( "mousedown", onMouseDown );
					scale_y_increase.addEventListener( "mousedown", onMouseDown );
					scale_x_decrease.addEventListener( "mousedown", onMouseDown );
					scale_y_decrease.addEventListener( "mousedown", onMouseDown );

					window.addEventListener( "mouseup", function (){
						clearTimeout( interval ); // important!
					//	debugMode && console.log( "on MouseUp:", interval );
					});

					scale_x_increase.addEventListener( "click", onMouseClick );
					scale_y_increase.addEventListener( "click", onMouseClick );
					scale_x_decrease.addEventListener( "click", onMouseClick );
					scale_y_decrease.addEventListener( "click", onMouseClick );

					function updateScale( button ){

						if ( !( button && scaleSelect.value) ) return;

						var step = 1/100;
						var max = 10, min = -max;
						var key = scaleSelect.value;

						var x = editor[key].x; 
						var y = editor[key].y; 

						if ( button === scale_x_increase ) editor[ key ].x = Math.min(max, x + step);
						if ( button === scale_y_increase ) editor[ key ].y = Math.min(max, y + step);
						if ( button === scale_x_decrease ) editor[ key ].x = Math.max(min, x - step);
						if ( button === scale_y_decrease ) editor[ key ].y = Math.max(min, y - step);

						displayVectorValues( scaleSelect.value );
					}

				})();

			//	color inputs.

				(function(){

					var interval;

					const color_r_input = document.getElementById("material-color-r-input");
					const color_g_input = document.getElementById("material-color-g-input");
					const color_b_input = document.getElementById("material-color-b-input");

					const color_r_increase = document.getElementById("material-color-r-increase");
					const color_g_increase = document.getElementById("material-color-g-increase");
					const color_b_increase = document.getElementById("material-color-b-increase");

					const color_r_decrease = document.getElementById("material-color-r-decrease");
					const color_g_decrease = document.getElementById("material-color-g-decrease");
					const color_b_decrease = document.getElementById("material-color-b-decrease");

					function onInputChange(){

						this.blur(); // important!

						var step = 1/255;

						var material = getMaterialByEntityId( entitySelect.value );

						if ( !(entitySelect.value && colorSelect.value) ) return resetValues();

						if ( material && entitySelect.value && colorSelect.value ) {

						//	Update.
							updateColor( this );

						//	Undo/Redo.
							addToUndo();

						}

						function resetValues(){

							color_r_input.value = parseInt( 255 * editor.color.r ).toFixed(0); // string.
							color_g_input.value = parseInt( 255 * editor.color.g ).toFixed(0); // string.
							color_b_input.value = parseInt( 255 * editor.color.b ).toFixed(0); // string.

							return;
						}

						function displayValue( input ){

							if ( !(input && colorSelect.value) ) return resetValues();

							var key = colorSelect.value;
							if ( input === color_r_input ) input.value = parseInt( 255 * editor[ key ].r ).toFixed(0); // string.
							if ( input === color_g_input ) input.value = parseInt( 255 * editor[ key ].g ).toFixed(0); // string.
							if ( input === color_b_input ) input.value = parseInt( 255 * editor[ key ].b ).toFixed(0); // string.

							return;
						}

						function updateColor( input ){

							if ( !(input && colorSelect.value) ) return resetValues();

							var key = colorSelect.value;
							var value = step * Math.abs( parseInt( input.value ) % 255 );

							if ( input === color_r_input ) editor[ key ].r = value; // update editor.
							if ( input === color_g_input ) editor[ key ].g = value; // update editor.
							if ( input === color_b_input ) editor[ key ].b = value; // update editor.

							material.color && editor.color && material.color.copy( editor.color ); // update material.
							material.emissive && editor.emissive && material.emissive.copy( editor.emissive ); // update material.
							material.specular && editor.specular && material.specular.copy( editor.specular ); // update material.

							return displayValue( input );
						}

					}

					color_r_input.addEventListener( "change", onInputChange );
					color_g_input.addEventListener( "change", onInputChange );
					color_b_input.addEventListener( "change", onInputChange );

					function onMouseClick(){

					//	clearTimeout( interval ); // important!

						if ( !colorSelect.value ) return;
						if ( !entitySelect.value ) return;

						var material = getMaterialByEntityId( entitySelect.value );

						if ( !material ) return;

					//	Update editor.
						entitySelect.value && colorSelect.value && updateColor( this ); // update editor.

					//	Update material.
						entitySelect.value && material.color && editor.color && material.color.copy( editor.color ); // update material.
						entitySelect.value && material.emissive && editor.emissive && material.emissive.copy( editor.emissive ); // update material.
						entitySelect.value && material.specular && editor.specular && material.specular.copy( editor.specular ); // update material.

					//	Undo/Redo.
						entitySelect.value && addToUndo( material );

						debugMode && console.log( "on Mouse Click:", interval );

					}

					function onMouseDown(){ 

						clearTimeout( interval ); // important!

						if ( !colorSelect.value ) return; // !editor.isEditing;
						if ( !entitySelect.value ) return; // !editor.isEditing;

						var material = getMaterialByEntityId( entitySelect.value );

						if ( !material ) return;

						var button = this;
						var clock = new THREE.Clock();

						interval = setTimeout( function onUpdate() {

							if ( !material ) return;
							if ( !colorSelect.value ) return;
							if ( !entitySelect.value ) return;

							entitySelect.value && colorSelect.value && updateColor( button ); // update editor.

						//	update material.
							entitySelect.value && material.color && editor.color && material.color.copy( editor.color ); // update material.
							entitySelect.value && material.emissive && editor.emissive && material.emissive.copy( editor.emissive ); // update material.
							entitySelect.value && material.specular && editor.specular && material.specular.copy( editor.specular ); // update material.

							var dt = clock.getDelta();
							interval = setTimeout( onUpdate, dt );
						//	debugMode && console.log( "on Update:", interval );

						}, 500);
					}

					color_r_increase.addEventListener( "mousedown", onMouseDown );
					color_g_increase.addEventListener( "mousedown", onMouseDown );
					color_b_increase.addEventListener( "mousedown", onMouseDown );
					color_r_decrease.addEventListener( "mousedown", onMouseDown );
					color_g_decrease.addEventListener( "mousedown", onMouseDown );
					color_b_decrease.addEventListener( "mousedown", onMouseDown );

					window.addEventListener( "mouseup", function (){
						clearTimeout( interval ); // important!
					//	debugMode && console.log( "on MouseUp:", interval );
					});

					color_r_increase.addEventListener( "click", onMouseClick );
					color_g_increase.addEventListener( "click", onMouseClick );
					color_b_increase.addEventListener( "click", onMouseClick );
					color_r_decrease.addEventListener( "click", onMouseClick );
					color_g_decrease.addEventListener( "click", onMouseClick );
					color_b_decrease.addEventListener( "click", onMouseClick );

					function updateColor( button ){

						var step = 1/255;
						var max = 1, min = 0;
						var key = colorSelect.value;

						var r = editor[key].r; 
						var g = editor[key].g; 
						var b = editor[key].b;

						if ( button === color_r_increase ) editor[ key ].r = Math.min(max, r + step);
						if ( button === color_g_increase ) editor[ key ].g = Math.min(max, g + step);
						if ( button === color_b_increase ) editor[ key ].b = Math.min(max, b + step);

						if ( button === color_r_decrease ) editor[ key ].r = Math.max(min, r - step);
						if ( button === color_g_decrease ) editor[ key ].g = Math.max(min, g - step);
						if ( button === color_b_decrease ) editor[ key ].b = Math.max(min, b - step);

						displayVectorValues( colorSelect.value );
					}

				})();

			//	DEMO - param inputs (TEMPORARY IMPLEMATATION - DEMO).
			//	!!! TODO: cases based on paramSelect.value, IMPORTANT !!!

				(function(){

					var interval;

					const param_value_input = document.getElementById("material-param-value-input");
					const param_value_increase = document.getElementById("material-param-value-increase");
					const param_value_decrease = document.getElementById("material-param-value-decrease");

					param_value_input.addEventListener( "change", onInputChange );
					param_value_increase.addEventListener( "click", onMouseClick );
					param_value_decrease.addEventListener( "click", onMouseClick );

					function onMouseClick(){

						var key = paramSelect.value;

					//	is boolean.

						if ( typeof editor[ key ] === "boolean" ) {
							editor[ key ] = !editor[ key ]; // update.
							param_value_input.value = editor[ key ]; // display.
							return;
						}

					//	is number (demo).

						if ( typeof editor[ key ] === "number" ) {

						//	var max = 100, min = -max;
						//	var step = 1 // for integer.
							var step = 1/100; // for float.

							if ( this === param_value_increase ) param_value_input.value = ( editor[ key ] += step ).toFixed(2); // update, display.
							if ( this === param_value_decrease ) param_value_input.value = ( editor[ key ] -= step ).toFixed(2); // update, display.

							return;
						}

					}

					function onInputChange(){

						this.blur(); // important!

						var step = 1/100;

					//	demo!

						if ( !(entitySelect.value && paramSelect.value) ) 

							return resetValue();

						if ( entitySelect.value && paramSelect.value ) {

						//	Update.
							updateValue( this );

						//	Undo/Redo.
							addToUndo();

						}

					//	demo!

						function resetValue(){

							param_value_input.value = "";

							return;
						}

					//	demo!

						function displayValue(){

							if ( !paramSelect.value ) return resetValue();

							var key = paramSelect.value;

							if ( editor[ key ] === undefined ) 
								return resetValue();
							else 
								param_value_input.value = editor[ key ];

							return;
						}

					//	demo!

						function updateValue(){

							if ( !paramSelect.value ) return resetValue();

							var key = paramSelect.value;

							if ( editor[ key ] === undefined ) return resetValue();

						//	is string.

							if ( typeof editor[ key ] === "string" ) {
								editor[ key ] = param_value_input.value; return;
							}

						//	is boolean.

							else if ( typeof editor[ key ] === "boolean" ) {
								editor[ key ] = Boolean( param_value_input.value ); return;
							}

						//	is number.

							else if ( typeof editor[ key ] === "number" && editor[ key ] !== NaN ) {
								if ( parseFloat( param_value_input.value ) !== NaN ) {

								//	float && float.
									if ( editor[ key ] % 1 !== 0 && parseFloat( param_value_input.value ) % 1 !== 0	) {
										editor[ key ] = parseFloat( param_value_input.value ); return;
									}

								//	float && integer.
									if ( ( editor[ key ] % 1 !== 0 && parseFloat( param_value_input.value ) % 1 === 0 ) 
										|| ( editor[ key ] % 1 === 0 && parseFloat( param_value_input.value ) % 1 !== 0 ) ) {
										editor[ key ] = parseFloat( param_value_input.value ); return;
									}

								//	integer && integer.
									if ( editor[ key ] % 1 === 0 && parseFloat( param_value_input.value ) % 1 === 0 ) {
										editor[ key ] = parseInt( param_value_input.value ); return;
									}

								} else return resetValue();

							} else return resetValue();

						} // end updateValue().

					} // onInputChange().

				})();

			//	Watchers.

				(function(){

					watch(editorTabSelect, function( prop, action, newValue, oldValue ){
					//	debugMode && console.log( "editorSelect watch:", 
					//	prop, action, "newValue:", newValue, "oldValue:", oldValue  );

						if ( !newValue ) return resetEntitySelectValue();

					//	Get object.
						var object = getObjectByEntityId( newValue );
						if ( !(object && object.material) ) return; // important!

					//	Get material.
						var material;
						if ( Array.isArray( object.material ) ) 
							material = object.material[0]; // get first material.
						else 
							material = object.material;

						updateEntitySelectValue( material.id.toString() ); // string.

					});

					watch(entitySelect, function( prop, action, newValue, oldValue ){
					//	debugMode && console.log( "entitySelect watch:", 
					//	prop, action, "newValue:", newValue, "oldValue:", oldValue  );

						switchToEditMode( newValue ); // important!

					//	Display vectors direct from editor.
						updateEntitySelectValue();
						updateTextureSelectValue();
						updateParamSelectValue();
						updateScaleSelectValue();
						updateColorSelectValue();
						updateMaterialTypeValue();

					//	Update vectors direct from editor.
						displayVectorValues( paramSelect.value );
						displayVectorValues( scaleSelect.value );
						displayVectorValues( colorSelect.value );

					});

					watch(textureSelect, function( prop, action, newValue, oldValue ){
						debugMode && console.log( "textureSelect watch:", prop, action, newValue );

					//	Update texture direct from editor.
						displayVectorValues( paramSelect.value );
						displayVectorValues( scaleSelect.value );
						displayVectorValues( colorSelect.value );

					});

					watch(paramSelect, function( prop, action, newValue, oldValue ){
						debugMode && console.log( "paramSelect watch:", prop, action, newValue );

					//	Update vectors direct from editor.
						displayVectorValues( newValue );

					});

					watch(scaleSelect, function( prop, action, newValue, oldValue ){
						debugMode && console.log( "scaleSelect watch:", prop, action, newValue );

					//	Update vectors direct from editor.
						displayVectorValues( newValue );

					});

					watch(colorSelect, function( prop, action, newValue, oldValue ){
						debugMode && console.log( "colorSelect watch:", prop, action, newValue );

					//	Update vectors direct from editor.
						displayVectorValues( newValue );

					});

				})();

				return editor;

			})( new THREE.Material() );

		</script>

		<script>
/*
		//	helper.

			function cloneSceneMaterials(){
			//	Returns an object with all in-scene materials
			//	keeping material.uuid but new material.id(s).
				var meta = { 
					geometries:{}, materials:{}, 
					textures:{}, images:{}, shapes:{} 
				}; 
				scene.toJSON( meta ); // important!
				var loader = new THREE.ObjectLoader();
				return loader.parseMaterials( meta.materials );
			}
*/
		</script>

		<script>
		/*
			//	editor copy.
			//	IMPORTANT !!! IMPORTANT !!! IMPORTANT !!!
			//	Overwrites THREE.Material.prototype.copy().

			editor.copy = function( source ){

				//	THREE Material.

				(function( editor ){

					var keys = "";

					keys += "name,type,uuid,side,opacity,alphaTest,transparent,premultipliedAlpha,";
					keys += "fog,lights,visible,overdraw,dithering,precision,colorWrite,flatShading,vertexColors,";
					keys += "blending,blendSrc,blendDst,blendEquation,blendSrcAlpha,blendDstAlpha,blendEquationAlpha,";
					keys += "depthFunc,depthTest,depthWrite,shadowSide,clipShadows,clipIntersection,";
					keys += "polygonOffset,polygonOffsetUnits,polygonOffsetFactor,";

					keys.split(",").forEach(function( key ){
						editor[ key ] = source[ key ];
					});

				})( this );

				(function( editor ){

					editor.userData = JSON.parse( JSON.stringify( source.userData ) );

					var srcPlanes = source.clippingPlanes,
						dstPlanes = null;

					if ( srcPlanes !== null ) {

						var n = srcPlanes.length;
						dstPlanes = new Array( n );

						for ( var i = 0; i !== n; ++ i )
							dstPlanes[ i ] = srcPlanes[ i ].clone();

					}

					editor.clippingPlanes = dstPlanes;

				})( this );

				//	THREE Mesh Material.

				(function( editor ){

					var keys = "color,emissive,specular,normalScale,displacementScale,";

					keys.split(",").forEach(function( key ){

						if ( source[ key ] === undefined ) delete editor[ key ];

						else if ( source[ key ] && editor[ key ] === undefined ) {
							switch ( key ){
								case "normalScale":
								case "displacementScale":
									editor[ key ] = new THREE.Vector2();
								break;
								default:
									editor[ key ] = new THREE.Color();
									break;
							} // end switch.
						} // end if else.

						//

						if ( source[ key ] && editor[ key ] ) {
							try {
								editor[ key ].copy( source[ key ] ); 
							} catch(err) {
								switch ( key ){
									case "color":
										editor[ key ].setRGB(1,1,1);
										break;
									case "emissive":
									case "specular":
										editor[ key ].setRGB(0,0,0);
										break;
									case "normalScale":
									case "displacementScale":
										editor[ key ].set(1,1);
									break;
								} // end switch(key).
							} // end catch(err).
						} // end if.

					}); // end forEach.

				})( this );

				//	THREE Mesh/Line/Point/Sprite Material.

				(function( editor ){

					var keys = "";

					keys += "map,aoMap,envMap,bumpMap,alphaMap,lightMap,normalMap,specularMap,";
					keys += "gradientMap,emissiveMap,metalnessMap,roughnessMap,displacementMap,";
					keys += "metalness,roughness,bumpScale,reflectivity,";
					keys += "refractionRatio,displacementBias,normalMapType,";
					keys += "aoMapIntensity,envMapIntensity,emissiveIntensity,lightMapIntensity,";
					keys += "wireframe,wireframeLinecap,wireframeLinejoin,wireframeLinewidth,";
					keys += "skinning,morphTargets,morphNormals,combine,shininess,";
					keys += "depthPacking,scale,gapSize,linecap,linejoin,linewidth,";
					keys += "dashSize,size,rotation,sizeAttenuation";

					keys.split(",").forEach(function( key ){
						if ( source[ key ] === undefined ) 
							delete editor[key];
						else 
							editor[ key ] = source[ key ];
					});

				})( this );

			};
		*/
		</script>

		<script>
		/*
			//	IMPORTANT !!! IMPORTANT !!! IMPORTANT !!! IMPORTANT !!!
			//	Overwrites THREE.Material.prototype.copy
			//	and MeshStandardMaterial.prototype.copy.

				editor.copy = function( source ){

				//	Overwrite THREE.Material.copy;
				//	THREE.Material.prototype.copy.call( editor, source );

					editor.name = source.name;
					editor.type = source.type;
					editor.uuid = source.uuid;
					editor.side = source.side;

					editor.opacity = source.opacity;
					editor.alphaTest = source.alphaTest;
					editor.transparent = source.transparent;
					editor.premultipliedAlpha = source.premultipliedAlpha;

					editor.fog = source.fog;
					editor.lights = source.lights;
					editor.visible = source.visible;
					editor.overdraw = source.overdraw;
					editor.dithering = source.dithering;
					editor.precision = source.precision;
					editor.colorWrite = source.colorWrite;
					editor.flatShading = source.flatShading;
					editor.vertexColors = source.vertexColors;

					editor.blending = source.blending;
					editor.blendSrc = source.blendSrc;
					editor.blendDst = source.blendDst;
					editor.blendEquation = source.blendEquation;
					editor.blendSrcAlpha = source.blendSrcAlpha;
					editor.blendDstAlpha = source.blendDstAlpha;
					editor.blendEquationAlpha = source.blendEquationAlpha;
					
					editor.depthFunc = source.depthFunc;
					editor.depthTest = source.depthTest;
					editor.depthWrite = source.depthWrite;

					editor.shadowSide = source.shadowSide;
					editor.clipShadows = source.clipShadows;
					editor.clipIntersection = source.clipIntersection;

					editor.polygonOffset = source.polygonOffset;
					editor.polygonOffsetUnits = source.polygonOffsetUnits;
					editor.polygonOffsetFactor = source.polygonOffsetFactor;

					editor.userData = JSON.parse( JSON.stringify( source.userData ) );

					var srcPlanes = source.clippingPlanes,
						dstPlanes = null;

					if ( srcPlanes !== null ) {

						var n = srcPlanes.length;
						dstPlanes = new Array( n );

						for ( var i = 0; i !== n; ++ i )
							dstPlanes[ i ] = srcPlanes[ i ].clone();

					}

					editor.clippingPlanes = dstPlanes;

				//	Overwrite THREE.MeshStandardMaterial.copy;
				//	THREE.MeshStandardMaterial.prototype.copy.call( editor, source );

					editor.defines = { "STANDARD": "" };

					editor.map = source.map;
					editor.aoMap = source.aoMap;
					editor.envMap = source.envMap;
					editor.bumpMap = source.bumpMap;
					editor.alphaMap = source.alphaMap;
					editor.lightMap = source.lightMap;
					editor.normalMap = source.normalMap;
					editor.emissiveMap = source.emissiveMap;
					editor.metalnessMap = source.metalnessMap;
					editor.roughnessMap = source.roughnessMap;
					editor.displacementMap = source.displacementMap;

					editor.metalness = source.metalness;
					editor.roughness = source.roughness;
					editor.bumpScale = source.bumpScale;
					editor.reflectivity = source.reflectivity;
					editor.normalMapType = source.normalMapType;
					editor.refractionRatio = source.refractionRatio;
					editor.displacementBias = source.displacementBias;
					editor.displacementScale = source.displacementScale;
					
					editor.aoMapIntensity = source.aoMapIntensity;
					editor.envMapIntensity = source.envMapIntensity;
					editor.emissiveIntensity = source.emissiveIntensity;
					editor.lightMapIntensity = source.lightMapIntensity;

					editor.wireframe = source.wireframe;
					editor.wireframeLinecap = source.wireframeLinecap;
					editor.wireframeLinejoin = source.wireframeLinejoin;
					editor.wireframeLinewidth = source.wireframeLinewidth;

					editor.skinning = source.skinning;
					editor.morphTargets = source.morphTargets;
					editor.morphNormals = source.morphNormals;

				//	mesh basic,phong,lambert material.

					if ( source.combine !== undefined ) 
						editor.combine = source.combine;
					else delete editor.combine;

					if ( source.shininess !== undefined ) 
						editor.shininess = source.shininess;
					else delete editor.shininess;

					if ( source.specularMap !== undefined ) 
						editor.specularMap = source.specularMap;
					else delete editor.specularMap;

				//	bypass vector.copy() errors.

					try { 
						editor.normalScale && source.normalScale 
						&& editor.normalScale.copy( source.normalScale ); 
					} catch(err){ 
						editor.normalScale && editor.normalScale.set(1,1); 
					}

				//	bypass color.copy() errors.

					try { 
						editor.color && source.color 
						&& editor.color.copy( source.color ); 
					} catch(err){ 
						editor.color && editor.color.setRGB(1,1,1); 
					}

					try { 
						editor.emissive && source.emissive 
						&& editor.emissive.copy( source.emissive ); 
					} catch(err){ 
						editor.emissive && editor.emissive.setRGB(0,0,0); 
					}

					try { 
						if ( editor.specular && source.specular )
							editor.specular.copy( source.specular ); 
						else delete editor.specular;
					} catch(err){ 
						editor.specular && editor.specular.setRGB(0,0,0); 
					}

				//	mesh toon,depth material.
					if ( source.gradientMap !== undefined ) 
						editor.gradientMap = source.gradientMap; // mesh toon material.
					else delete editor.gradientMap;

					if ( source.depthPacking !== undefined ) 
						editor.depthPacking = source.depthPacking; // mesh depth material.
					else delete editor.depthPacking;

				//	line basic,dashed material.
					if ( source.scale !== undefined ) editor.scale = source.scale; else delete editor.scale;
					if ( source.gapSize !== undefined ) editor.gapSize = source.gapSize; else delete editor.gapSize;
					if ( source.linecap !== undefined ) editor.linecap = source.linecap; else delete editor.linecap;
					if ( source.linejoin !== undefined ) editor.linejoin = source.linejoin; else delete editor.linejoin;
					if ( source.linewidth !== undefined ) editor.linewidth = source.linewidth; else delete editor.linewidth;
					if ( source.dashSize !== undefined ) editor.dashSize = source.dashSize; else delete editor.dashSize;

				//	sprite,point material.
					if ( source.size !== undefined ) editor.size = source.size; else delete editor.size;
					if ( source.rotation !== undefined ) editor.rotation = source.rotation; else delete editor.rotation;
					if ( source.sizeAttenuation !== undefined ) editor.sizeAttenuation = source.sizeAttenuation; else delete editor.sizeAttenuation;

				};
		*/
		</script>

		<script>

			localPlayer.controller.movementSpeed = 10;

		//	Entities.

		//	debugMode && (function(){
		//		var r = 1;
		//		var geometry = new THREE.BoxGeometry(r,r,r);
		//		var material = new THREE.MeshLambertMaterial();
		//		var cube = new THREE.Mesh(geometry, material);
		//		cube.name = "local player cube";
		//		var geometry = new THREE.SphereGeometry(0.7,8,12);
		//		var material = new THREE.MeshLambertMaterial();
		//		var sphere = new THREE.Mesh(geometry, material);
		//		sphere.name = "local player sphere";
		//	//	cube.add( sphere );
		//		localPlayer.add( cube );
		//	})();

		//	box coluctions.

			debugMode && (function(){

				var material = new THREE.MeshLambertMaterial({name:"mtl00"});

				(function(){
					var w = 10; var h = 5;
					var box = new THREE.BoxGeometry(w,h,w);
					box.translate(0, h/2, 0);
					octree.importThreeMesh( new THREE.Mesh(box) );
					var geometry = new THREE.EdgesGeometry( box );
					var material = new THREE.LineBasicMaterial( { color: 0x00ff00 } );
					var segments = new THREE.LineSegments( geometry, material );
					segments.name = "segments 1";
					scene.add( segments );
				})();

				(function(){
					var w = 10, h = 20;
					var x = 10, y = h/2, z = -4;
					var box = new THREE.BoxGeometry(w,h,w);
					box.translate(0, h/2, 0);
					var material = new THREE.MeshLambertMaterial();
					var mesh = new THREE.Mesh(box, material);
					mesh.name = "building 1";
					mesh.position.set(x,0,z);
					octree.importThreeMesh( mesh );
					var geometry = new THREE.EdgesGeometry( box );
					var segments = new THREE.LineSegments( geometry, material );
					segments.name = "segments 2";
					segments.position.copy( mesh.position );
					scene.add( mesh );
					cameraControls.rigidObjects.push( mesh );
				})();

				(function(){
					var w = 12, h = 10;
					var x = 15, y = h/2, z = -11;
					var box = new THREE.BoxGeometry(w,h,w);
					box.translate(0, h/2, 0);
					var material = new THREE.MeshLambertMaterial();
					var mesh = new THREE.Mesh(box, material);
					mesh.name = "building 2";
					mesh.position.set(x,0,z);
					octree.importThreeMesh( mesh );
					var geometry = new THREE.EdgesGeometry( box );
					var segments = new THREE.LineSegments( geometry, material );
					segments.name = "segments 3";
					segments.position.copy( mesh.position );
					scene.add( mesh );
					cameraControls.rigidObjects.push( mesh );
				})();

				(function(){
					var w = 8, h = 10;
					var x = -9, y = h/2, z = 5;
					var box = new THREE.BoxGeometry(w,h,w);
					box.translate(0, h/2, 0);
					var material = new THREE.MeshLambertMaterial();
					var mesh = new THREE.Mesh(box, material);
					mesh.name = "building 3";
					mesh.position.set(x,0,z);
					octree.importThreeMesh( mesh );
					var geometry = new THREE.EdgesGeometry( box );
					var segments = new THREE.LineSegments( geometry, material );
					segments.name = "segments 4";
					segments.position.copy( mesh.position );
					scene.add( mesh );
					cameraControls.rigidObjects.push( mesh );
				})();

				(function(){
					var w = 12, h = 20, d = 2;
					var x = -14, y = h/2, z = 10;
					var box = new THREE.BoxGeometry(w,h,d);
					box.translate(0, h/2, 0);
					var material = new THREE.MeshLambertMaterial();
					var mesh = new THREE.Mesh(box, material);
					mesh.name = "building 4";
					mesh.position.set(x,0,z);
					octree.importThreeMesh( mesh );
					var geometry = new THREE.EdgesGeometry( box );
					var segments = new THREE.LineSegments( geometry, material );
					segments.name = "segments 5";
					segments.position.copy( mesh.position );
					scene.add( mesh );
					cameraControls.rigidObjects.push( mesh );
				})();

				(function(){
					var w = 4, h = 20, d = 20;
					var x = -17, y = h/2, z = 12;
					var box = new THREE.BoxGeometry(w,h,d);
					box.translate(0, h/2, 0);
					var material = new THREE.MeshLambertMaterial();
					var mesh = new THREE.Mesh(box, material);
					mesh.name = "building 5";
					mesh.position.set(x,0,z);
					octree.importThreeMesh( mesh );
					var geometry = new THREE.EdgesGeometry( box );
					var segments = new THREE.LineSegments( geometry, material );
					segments.name = "segments 6";
					segments.position.copy( mesh.position );
					scene.add( mesh );
					cameraControls.rigidObjects.push( mesh );
				})();

			//	var groupA = new THREE.Object3D();
			//	var groupB = new THREE.Object3D();

			//	groupA.add( scene.getObjectByName("building 1").clone() );
			//	groupA.add( scene.getObjectByName("building 2").clone() );
			//	groupB.add( scene.getObjectByName("building 3").clone() );
			//	groupB.add( scene.getObjectByName("building 4").clone() );
			//	groupB.add( scene.getObjectByName("building 5").clone() );

			})();

		</script>

		<script>

		//	Add entities.

		//	Add Object3D entities.
			scene.traverse(function( object ){
				entities.add( object );
			});

		//	Add Material entities.
			entities.forEach( function( entity ){

			//	It looks in "entities" manager only.
			//	It looks the root Object3D, but not children.

				var object = scene.getObjectById( entity.id );
				if ( !object.material ) return; // important!

				if ( Array.isArray( object.material ) )
					object.material.forEach( addtoManager );
				else 
					addtoManager( object.material );

				function addtoManager( material ){
					rename( material );
					addEntity( material );
				}

				function rename( material ){
					if ( material.name ) return;
					material.name = "mtl"+material.id;;
				}

				function addEntity( material ){
					var included = material_entities.includes( material );
					debugMode && console.log( "included:", included );
					if ( !included ) material_entities.add( material );
				}
			});

			console.log( {"object3DEditor": object3DEditor} ); // debug!
			console.log( {"materialEditor": materialEditor} ); // debug!

		</script>

	</body>
</html>
