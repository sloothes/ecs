<!DOCTYPE html>
<html lang="en">
	<head>

		<title>Legacy ECS Engine (pre-alpha 0.17)</title>

		<meta charset="utf-8">
		<meta name="generator" content="Three.js Editor">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<link rel="stylesheet" href="/css/joystick.css">
		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootbox-dialoges.css">
		<link rel="stylesheet" href="/css/jcrop.css">

		<script src="/js/watch.js"></script>
		<script src="/js/Objectid.js"></script>
		<script src="/js/jquery.min.js"></script> 
		<script src="/js/system.min.js"></script>
		<script src="/js/signals.min.js"></script>
		<script src="/js/inflate.min.js"></script>
		<script src="/js/zangodb.min.js"></script>
		<script src="/js/bootstrap.min.js"></script>
		<script src="/js/hold-event.min.js"></script>
		<script src="/js/jcrop.js"></script>

		<style>

			body {
				margin: 0px;
				font-size: 13px;
				font-family: sans-serif;
				background-repeat: repeat;
				background-image: url("https://i.imgur.com/rnZZU0i.png") !important;
				overflow: hidden;
			}

			#loading-bar {
				width:100%;
				height:100%;
				top:0; left:0;
				position:fixed;
				display:flex;
				align-items:center;
				justify-content:center;
			}

			.middle > * {
				top:0; 
				left:0;
				right:0;
				bottom:0;
				margin:auto;
				position:absolute;
			}

			#joystick1 {
				right: calc(40px + 370px);
			}
			
			#jumpButton {
				right: calc(105px + 370px);
			}

			.btn-matcap,
			.btn-terrain {
				padding:0;
				float:left;
				width:55px;
				height:55px;
				border:1px solid;
				border-radius:4px;
				margin-right:4px;
				margin-bottom:4px;
				display:inline-block;
			}

			.btn-matcap + .btn-matcap,
			.btn-terrain + .btn-terrain {
				margin-right:4px;
			}

		</style>
	</head>

	<body ontouchstart="">

		<script>

			debugMode = true;
			const Signal = signals.Signal;

		</script>

		<script src="/ecs/js/three.js"></script>
		<script src="/ecs/js/TabUI.js"></script>
		<script src="/ecs/js/MeshWalk.js"></script>
		<script src="/ecs/js/UVsDebug.js"></script>
		<script src="/ecs/js/FBXLoader.js"></script>
		<script src="/ecs/js/VirtualInput.js"></script>
		<script src="/ecs/js/KeyboardState.js"></script>
		<script src="/ecs/js/EditorControls.js"></script>
		<script src="/ecs/js/camera-controls.js"></script>
		<script src="/ecs/js/SubdivisionModifier.js"></script>
		<script src="/ecs/js/three-pathfinding.umd.js"></script>
		<script src="/threejs/r96/examples/js/loaders/GLTFLoader.js"></script>
		<script src="/threejs/r96/examples/js/exporters/GLTFExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/STLExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/OBJExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/ColladaExporter.js"></script>

		<script>

		//	TabUI.

			(function(){

				var sidePanel = createSidePanel();
				document.body.appendChild( sidePanel );

				var loginTab = TabUI.add( "Login", "login-tab" );
				var debugTab = TabUI.add( "Debug", "debug-tab" );
				var levelTab = TabUI.add( "Levels", "level-tab" );
				var editorTab = TabUI.add( "Editor", "editor-tab" );
				var cameraTab = TabUI.add( "Camera", "camera-tab" );
				var controlTab = TabUI.add( "Controls", "control-tab" );
				var playersTab = TabUI.add( "Players", "players-tab" );
				var textureTab = TabUI.add( "Texture", "texture-tab" );
				var geoemtryTab = TabUI.add( "Geometry", "geometry-tab" );
				var materialTab = TabUI.add( "Material", "material-tab" );
				var animationTab = TabUI.add( "Animations", "animation-tab" );

				TabUI.append("Editor", "Geometry", "Material", "Texture", "Controls", "Camera", "Players", "Animations", "Levels", "Debug" );
				TabUI.Material.role.classList.add("active");
				TabUI.Material.tab.classList.add("in","active");

			})();

		</script>

		<script src="/ecs/engine/core/enviroment.js"></script>
		<script src="/ecs/engine/core/entity.js"></script>
		<script src="/ecs/engine/core/helpers.js"></script>
		<script src="/ecs/engine/core/localPlayer.js"></script>
		<script src="/ecs/engine/core/cameraControls.js"></script>
		<script src="/ecs/engine/core/keyboardState.js"></script>
		<script src="/ecs/engine/core/keyInputControls.js"></script>
		<script src="/ecs/engine/core/joystickControls.js"></script>
		<script src="/ecs/engine/core/keyboard.js"></script>
		<script src="/ecs/engine/editor/EditorTab.js"></script>
	<!-- script src="/ecs/engine/editor/MaterialManager.js"></script -->
	<!-- script src="/ecs/engine/editor/MaterialTab.js"></script -->
	<!-- script src="/ecs/engine/editor/MaterialEditor.js"></script -->


		<script>

		//	Material Manager Class.

		//	Material Manager: inherits (extends) Array class.
		//	sources: https://stackoverflow.com/questions/26700164/extending-array-with-es6-classes
		//	https://stackoverflow.com/questions/11337849/ways-to-extend-array-object-in-javascript

			function MaterialManager(){
				var array = new Array(0);
				Object.setPrototypeOf( array, MaterialManager.prototype );
				return array; // important!
			};

			MaterialManager.prototype = Object.create(Array.prototype);
			MaterialManager.prototype.move = function( entity, new_index ){

				var old_index = this.findIndex(function( item ){
					return item.id === entity.id;
				});

				if ( old_index < 0 ) return; // important!
				if ( old_index == new_index ) return;

				(function( arr, old_index, new_index ){

					if (new_index >= arr.length) {
						var k = new_index - arr.length + 1;
						while (k--) {
							arr.push(undefined);
						}
					}

					arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);

				})( this, old_index, new_index);

			};

			MaterialManager.prototype.add = function(){
			//	params: {object:Material} 

				if ( arguments.length < 1 ) return;

				var materials  = [];

			//	Get materials/ids.
				for ( var i in arguments ) {
					var param = arguments[i];
					if ( typeof param === "object" && param.isMaterial && param.id !== undefined )
						materials.push( param );  // meterial;
					else 
						continue;
				}

				if ( !materials.length ) return;
			//	console.log( "materials:", materials );

				var length = materials.length;
				for ( var j = 0; j < length; j++ ) {
					this.push( materials[j] );
				}

			//	var material_droplist = document.getElementById("material-entities-droplist");
			//	global const "material_droplist" is defined in MaterialTab.js;
				if ( !material_droplist ) return;

			//	Add options.
				while ( materials.length ) (function( material ){
					var str =  "", dot = ".", col = ":";
					var type = "object";
					var name = material.name || "mtl"+material.id;
					if ( material.type ) type = material.type;
					var option = document.createElement("option");
					option.text = str+material.id+dot+type+col+name;
					option.value = material.id;
					material_droplist.appendChild( option );
				})( materials.shift() );
			};

			MaterialManager.prototype.remove = function(){
			//	params: {number:entity.id} or {object:entity} 

				if ( arguments.length < 1 ) return;

			//	Get removed ids.
				var remove_ids = [];
				for ( var i in arguments ) {
					var param = arguments[i];
					if ( typeof param === "number" && param % 1 === 0 ) // integer. 
						remove_ids.unshift( param );    // remove_ids.push( param );
					else if ( typeof param === "object" && param.isMaterial && param.id !== undefined )
						remove_ids.unshift( param.id ); // remove_ids.push( param.id );
					else 
						continue;
				}

				if ( !remove_ids.length ) return;
			//	console.log( "remove_ids:", remove_ids );

				var length = remove_ids.length;
				for ( var j = 0; j < length; j++ ) {

					var _id = remove_ids[ j ];

				//	Find index.
					var index = this.findIndex(function( item ){
						return item.id === _id;
					});

					if ( index < 0 ) continue; // important!

					var removedItems = this.splice(index, 1);
				//	debugMode && console.log( removedItems );

					while ( removedItems.length ){
						var removed = removedItems.shift();
					//	debugMode && console.log( removed );
						removed_materials.push( removed );
					}
				}

			//	var material_droplist = document.getElementById("material-entities-droplist");
			//	global const "material_droplist" is defined in MaterialTab.js;
				if ( !material_droplist ) return;

			//	Remove options.
				while ( remove_ids.length ) (function( id ){
					var selector = "option[value='" + id.toString() + "']"; // console.log( selector );
					var option = material_droplist.querySelector( selector ); // console.log(  option  );
					option && option.remove();
				})( remove_ids.shift() );

			};

			MaterialManager.prototype.clear = function(){

				this.length = 0;

			};

		//	Create material managers.

			const material_entities = new MaterialManager(); // material entities array, important!.
			const removed_materials = new MaterialManager(); // material entities array, important!.

		</script>

		<script>

		//	Material Tab.

		//	TabUI.append("Material");
		//	TabUI.Editor.role.classList.add("active");
		//	TabUI.Editor.tab.classList.add("in","active");

			const material_droplist = (function( tab ){

			//	Materials droplist.
			//	When option is selected, switches to EditMode.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "Entities:";
				row.style.cssText = "height:30px;"

				var select = document.createElement("select");
				select.id = "material-entities-droplist";
				select.style.cssText = "width:190px;color:#000;float:right;"
					+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
					+ "font-size:20px;margin-left:10px;margin-right:15px;";

				(function(){
					var option = document.createElement("option");
					option.value = "";
					select.appendChild( option );
				})();

				row.appendChild( select );
				tab.appendChild( row );

				return select;

			})( TabUI.Material.tab );

			(function( tab ){

			//	Material map droplist.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "texture:";
				row.style.cssText = "height:30px;"

				var select = document.createElement("select");
				select.id = "material-map-droplist";
				select.style.cssText = "width:190px;color:#000;float:right;"
					+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
					+ "font-size:20px;margin-left:10px;margin-right:15px;";

				var keys = "map,bumpMap,emissiveMap,metalnessMap,roughnessMap,"
				  + "displacementMap,alphaMap,normalMap,lightMap,aoMap,envMap";

				keys.split(",").forEach(function( name ){
					var option = document.createElement("option");
					option.text = name;
					option.value = name;
					select.appendChild( option );
				});

				row.appendChild( select );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Vector mode droplist.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "select:";
				row.style.cssText = "height:40px;"

				var select = document.createElement("select");
				select.id = "material-vector-droplist";
				select.style.cssText = "width:190px;color:#000;float:right;"
					+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
					+ "font-size:20px;margin-left:10px;margin-right:15px;";

				var keys = "";
				keys.split(",").forEach(function( name ){
					var option = document.createElement("option");
					option.text = name;
					option.value = name;
					select.appendChild( option );
				});

				row.appendChild( select );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Undo/Redo button.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.style.cssText = "height:40px;margin-bottom:20px;"

				var redo = document.createElement("div");
				redo.id = "material-redo-button";
				redo.textContent = "Redo";
				redo.style.cssText = "width:45%;float:left;height:40px;font-size:large;margin-right:15px;";
				redo.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				var undo = document.createElement("div");
				undo.id = "material-undo-button";
				undo.textContent = "Undo";
				undo.style.cssText = "width:45%;float:right;height:40px;font-size:large;margin-right:15px;";
				undo.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				row.appendChild( redo );
				row.appendChild( undo );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Exit edit mode button.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.style.cssText = "height:40px;margin-bottom:20px;"

				var button = document.createElement("div");
				button.id = "material-exit-mode";
				button.textContent = "Exit Edit Mode";
				button.style.cssText = "width:295px;float:right;height:40px;font-size:large;margin-right:15px;";
				button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				row.appendChild( button );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Material Type droplist.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.textContent = "Material:";
				row.style.cssText = "height:40px;margin-top:40px;"

				var select = document.createElement("select");
				select.id = "material-type-droplist";
				select.style.cssText = "width:190px;color:#000;float:right;"
					+ "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;"
					+ "font-size:20px;margin-left:10px;margin-right:15px;";

				(function(){

					var materials = "MeshBasicMaterial,MeshStandardMaterial,MeshLambertMaterial,MeshPhongMaterial,"
						+ "MeshDepthMaterial,MeshNormalMaterial,MeshToonMaterial,MeshPhysicalMaterial,PointsMaterial,"
						+ "LineBasicMaterial,LineDashedMaterial,RawShaderMaterial,ShaderMaterial,ShadowMaterial,SpriteMaterial";

					materials.split(",").forEach(function( name ){
						var option = document.createElement("option");
						option.text = name;
						option.value = name;
						select.appendChild( option );
					});

				})();

				select.value = "MeshStandardMaterial";
				row.appendChild( select );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Create material entity button.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.style.cssText = "height:40px;margin-bottom:20px;"

				var button = document.createElement("div");
				button.id = "create-material-button";
				button.textContent = "Create Material Entity";
				button.style.cssText = "width:295px;float:right;height:40px;font-size:large;margin-right:15px;";
				button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				row.appendChild( button );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Clone material button.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.style.cssText = "height:40px;margin-bottom:20px;"

				var button = document.createElement("div");
				button.id = "clone-material-button";
				button.textContent = "Clone Geometry Entity";
				button.style.cssText = "width:295px;float:right;height:40px;font-size:large;margin-right:15px;";
				button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				row.appendChild( button );
				tab.appendChild( row );

			})( TabUI.Material.tab );

			(function( tab ){

			//	Remove material entity button.
			//	var tab = TabUI.Material.tab;

				var row = document.createElement("h3");
				row.style.cssText = "height:40px;margin-bottom:20px;"

				var button = document.createElement("div");
				button.id = "remove-material-button";
				button.textContent = "Remove Material Entity";
				button.style.cssText = "width:295px;float:right;height:40px;font-size:large;margin-right:15px;";
				button.classList.add( "form-control", "btn", "btn-primary", "btn-white-outline", "gradient-btn" );

				row.appendChild( button );
				tab.appendChild( row );

			})( TabUI.Material.tab );

		</script>

		<script>

		//	Material Editor.

		//	Create a Material to hold editor values.
			const materialEditor = (function( editor ){

			//	var k = 0;
			//	const materials = {};
				const undo = [], redo = [];

				const entity_droplist = document.getElementById("material-entities-droplist");
				const vector_droplist = document.getElementById("material-vector-droplist");
				const texture_droplist = document.getElementById("material-map-droplist");
				const material_droplist = document.getElementById("material-type-droplist");

				const redo_button = document.getElementById("material-redo-button");
				const undo_button = document.getElementById("material-undo-button");
				const exit_edit_button = document.getElementById("material-exit-mode");
				const create_material_button = document.getElementById("create-material-button");
				const clone_material_button = document.getElementById("clone-material-button");
				const remove_material_button = document.getElementById("remove-material-button");

				const entitySelect = { value:entity_droplist.value };   // string.
				const vectorSelect = { value:vector_droplist.value };   // string.
				const textureSelect = { value:texture_droplist.value }; // string.
				const materialType = { value:material_droplist.value }; // string.

			//	editor helpers.

				function resetEntitySelectValue(){
					entitySelect.value = entity_droplist.value = "";
				}

				function resetVectorSelectValue(){
					vectorSelect.value = vector_droplist.value = "";
				}

				function resetTextureSelectValue(){
					textureSelect.value = texture_droplist.value = "";
				}

				function updateEntitySelectValue(){
					entitySelect.value = entity_droplist.value;
				}

				function updateVectorSelectValue(){
					vectorSelect.value = vector_droplist.value;
				}

				function updateTextureSelectValue(){
					textureSelect.value = texture_droplist.value;
				}
				
				function updateMaterialTypeValue(){
					materialType.value = material_droplist.value;
				}

				function getMaterialByEntityId( value ){
					var id = parseInt( value );
					return material_entities.find( function( material ){
						return material.id === id;
					});
				}

				function exitFromEditMode(){
					editor.reset(); // important!
					resetEntitySelectValue();
					return;
				}

				function switchToEditMode( value ){
					if ( !editor.update( value ) ) 
						exitFromEditMode();
				}

				function addToUndo(){
					redo.length = 0; // important!
					var json = editor.toJSON();
					json && undo.unshift( json );
				//	debugMode && console.log( arguments.callee.name+"!" );
				}

				function addToRedo(){
					var json = editor.toJSON();
					json && redo.unshift( json );
				//	debugMode && console.log( arguments.callee.name+"!" );
				}

			//	IMPORTANT !!! IMPORTANT !!! IMPORTANT !!! IMPORTANT !!!
			//	Overwrites editor.copy (THREE.Material.prototype.copy).

				editor.copy = function( source ){

				//	THREE Material.

					(function( editor ){

						var keys = "";

						keys += "name,type,uuid,side,opacity,alphaTest,transparent,premultipliedAlpha,";
						keys += "fog,lights,visible,overdraw,dithering,precision,colorWrite,flatShading,vertexColors,";
						keys += "blending,blendSrc,blendDst,blendEquation,blendSrcAlpha,blendDstAlpha,blendEquationAlpha,";
						keys += "depthFunc,depthTest,depthWrite,shadowSide,clipShadows,clipIntersection,";
						keys += "polygonOffset,polygonOffsetUnits,polygonOffsetFactor,";

						keys.split(",").forEach(function( key ){
							editor[ key ] = source[ key ];
						});

					})( this );

					(function( editor ){

						editor.userData = JSON.parse( JSON.stringify( source.userData ) );

						var srcPlanes = source.clippingPlanes,
							dstPlanes = null;

						if ( srcPlanes !== null ) {

							var n = srcPlanes.length;
							dstPlanes = new Array( n );

							for ( var i = 0; i !== n; ++ i )
								dstPlanes[ i ] = srcPlanes[ i ].clone();

						}

						editor.clippingPlanes = dstPlanes;

					})( this );

				//	THREE Mesh Material.

					(function( editor ){

						var keys = "color,emissive,specular,normalScale,";

						keys.split(",").forEach(function( key ){

							if ( source[ key ] === undefined ) delete editor[ key ];

							else if ( source[ key ] && editor[ key ] === undefined ) {
								switch ( key ){
									case "normalScale":
										editor[ key ] = new THREE.Vector2();
									break;
									default:
										editor[ key ] = new THREE.Color();
									break;
								} // end switch.
							} // end if else.

						//

							if ( source[ key ] && editor[ key ] ) {
								try {
									editor[ key ].copy( source[ key ] ); 
								} catch(err) {
									switch ( key ){
										case "color":
											editor[ key ].setRGB(1,1,1);
										break;
										case "emissive":
										case "specular":
											editor[ key ].setRGB(0,0,0);
										break;
										case "normalScale":
											editor[ key ].set(1,1);
										break;
									} // end switch(key).
								} // end catch(err).
							} // end if.

						}); // end forEach.

					})( this );

				//	THREE Mesh/Line/Point/Sprite Material.

					(function( editor ){

						var keys = "";

						keys += "map,aoMap,envMap,bumpMap,alphaMap,lightMap,normalMap,";
						keys += "emissiveMap,metalnessMap,roughnessMap,displacementMap,";
						keys += "metalness,roughness,bumpScale,reflectivity,normalMapType,";
						keys += "refractionRatio,displacementBias,displacementScale,";
						keys += "aoMapIntensity,envMapIntensity,emissiveIntensity,lightMapIntensity,";
						keys += "wireframe,wireframeLinecap,wireframeLinejoin,wireframeLinewidth,";
						keys += "skinning,morphTargets,morphNormals,combine,shininess,specularMap,";
						keys += "gradientMap,depthPacking,scale,gapSize,linecap,linejoin,linewidth,";
						keys += "dashSize,size,rotation,sizeAttenuation";

						keys.split(",").forEach(function( key ){
							if ( source[ key ] === undefined ) 
								delete editor[key];
							else 
								editor[ key ] = source[ key ];
						});

					})( this );

				};

				editor.reset = function(){

					editor.copy( new THREE.Material() ); // overwrites material.copy();

				//	editor.name = "materialEditor";

					undo.length = 0; redo.length = 0; // clear undo/redo.
				//	debugMode && console.log( "material editor reset:", editor );
				};

				editor.update = function( value ){

				//	Reset editor.
					editor.reset();

				//	Get new material.
					var material = getMaterialByEntityId( value ); 

					if ( !material ) return false; // important!

				//	Copy material.
					material && editor.copy( material ); // overwrites material.copy();

				//	keep initial state.
					material && addToUndo();
					debugMode && console.log( "material editor updated:", editor );

					return true; // important!
				};

			//	Editor undo/redo.

				(function(){

					var interval;

					editor.undo = function(){ 

						if ( !undo.length ) return;

					//	Get undo json.
						var json = undo.shift();

						if ( !json ) return;

					//	Move json to redo.
						redo.unshift( json );

						clearTimeout( interval );
						interval = setTimeout( function(){

						//	Copy state (undo).
							var loader = new THREE.MaterialLoader();
							editor.copy( loader.parse( json ) );

						}, 250);
					};

					editor.redo = function(){

						if ( !redo.length ) return;

					//	Get redo json.
						var json = redo.shift();

						if ( !json ) return;

					//	Move json to undo.
						undo.unshift( json );

						clearTimeout( interval );
						interval = setTimeout( function(){

						//	Copy state (redo).
							var loader = new THREE.MaterialLoader();
							editor.copy( loader.parse( json ) );

						}, 250);
					};

				})();

			//	Droplists.

				(function(){

					entity_droplist.addEventListener("change", onChangeSelectValue );
					vector_droplist.addEventListener("change", onChangeSelectValue );
					texture_droplist.addEventListener("change", onChangeSelectValue );
					material_droplist.addEventListener("change", onChangeSelectValue );

					function onChangeSelectValue(){

						entity_droplist.blur();
						vector_droplist.blur();
						texture_droplist.blur();
						material_droplist.blur();

						entitySelect.value = entity_droplist.value; // updateEntitySelectValue();
						vectorSelect.value = vector_droplist.value; // updateVectorSelectValue();
						materialType.value = material_droplist.value; // updateMaterialTypeValue();
						textureSelect.value = texture_droplist.value; // updateTextureSelectValue()

					}

				})();

			//	Buttons.

				(function(){

					var interval;

					create_material_button.addEventListener( "click", function(){
						clearTimeout( interval );
						interval = setTimeout(function(){
							
						//	Get type.
							var type = materialType.value;
							if ( type === "" || type === undefined ) return;

						//	Init params based on type.
							switch (type) {
								//	case "PointsMaterial":
								//	case "SpriteMaterial":
								//	case "ShaderMaterial":
								//	case "ShadowMaterial":
								//	case "MeshToonMaterial":
								//	case "MeshBasicMaterial":
								//	case "MeshPhongMaterial":
								//	case "MeshDepthMaterial":
								//	case "MeshNormalMaterial":
								//	case "MeshLambertMaterial":
								//	case "MeshStandardMaterial":
								//	case "MeshPhysicalMaterial":
								//	case "RawShaderMaterial":
								//	case "LineBasicMaterial":
								//	case "LineDashedMaterial":
								//	break;
							}

						//	Create.
							var material = new THREE[ type ]();
							if ( material === undefined ) return;
						//	Name it.
							material.name = "mtl"+material.id;
						//	Add entity.
							material_entities.add( material );

						//	Enter edit mode.
							entitySelect.value = entity_droplist.value = material.id.toString();
						//	entity_droplist.dispatchEvent(new Event("change")); // important!

						}, 250);
					});

					clone_material_button.addEventListener( "click", function(){
						clearTimeout( interval );
						interval = setTimeout(function(){

							var id = parseInt( entitySelect.value );
							if ( id === NaN || id === undefined ) return;

						//	Get source.
							var source = getMaterialByEntityId( id );
							if ( !(source && source.isMaterial) ) return;

						//	Clone source.
							if ( source && source.isMaterial ) {
							//	clone.
								var material = material.clone();
							//	rename.
								material.name = source.name.replace(/:clone/g,"") + ":clone"; // TODO: better renameing.
							//	add entity.
								material_entities.add( material );
							//	update entity select value (switch editor target).
								entitySelect.value = entity_droplist.value = mesh.id.toString();
							//	entity_droplist.dispatchEvent(new Event("change")); // important!
							}

						}, 250);
					});

					remove_material_button.addEventListener( "click", function(){
						clearTimeout( interval );
						interval = setTimeout(function(){

							var id = parseInt( entitySelect.value );
							if ( id === NaN || id === undefined ) return;

						//	Remove material.
							material_entities.remove( id );

						}, 250);
					});

				})();

			//	Material Tab watchers.

				(function(){

					watch(entitySelect, function( prop, action, newValue, oldValue ){
					//	debugMode && console.log( "entitySelect watch:", 
					//	prop, action, "newValue:", newValue, "oldValue:", oldValue  );

						switchToEditMode( newValue ); // important!

					//	Display vectors direct from editor.
					//	updateVectorSelectValue();
					//	displayVectorValues( vectorSelect.value );

					});

					watch(vectorSelect, function( prop, action, newValue, oldValue ){
					//	debugMode && console.log( "vectorSelect watch:", prop, action, newValue );

					//	Update vectors direct from editor.
					//	displayVectorValues( vectorSelect.value );

					});

					watch(textureSelect, function( prop, action, newValue, oldValue ){
					//	debugMode && console.log( "vectorSelect watch:", prop, action, newValue );

					//	Update texture direct from editor.
					//	displayVectorValues( vectorSelect.value );

					});

				})();

				function displayVectorValues( vector ){

					if ( vector === "color" ) {}
					if ( vector === "emissive" ) {}
					if ( vector === "specular" ) {}

					if ( vector === "metalness" ) {}
					if ( vector === "roughness" ) {}
					if ( vector === "shininess" ) {}

					if ( vector === "bumpScale" ) {}
					if ( vector === "normalScale" ) {}

					if ( vector === "side" ) {}
					if ( vector === "opacity" ) {}
					if ( vector === "blending" ) {}
					if ( vector === "alphaTest" ) {}

					if ( vector === "aoMapIntensity" ) {}
					if ( vector === "displacementBias" ) {}
					if ( vector === "displacementScale" ) {}
					if ( vector === "emissiveIntensity" ) {}
					if ( vector === "envMapIntensity" ) {}
					if ( vector === "lightMapIntensity" ) {}

					if ( vector === "polygonOffsetFactor" ) {}
					if ( vector === "polygonOffsetUnits" ) {}

					if ( vector === "refractionRatio" ) {}
					if ( vector === "wireframeLinewidth" ) {}

				}


				function cloneSceneMaterials(){
				//	Returns an object with all in-scene materials
				//	keeping material.uuid but new material.id(s).
					var meta = { 
						geometries:{}, materials:{}, 
						textures:{}, images:{}, shapes:{} 
					}; 
					scene.toJSON( meta ); // important!
					var loader = new THREE.ObjectLoader();
					return loader.parseMaterials( meta.materials );
				}

			//	Init editor.
				editor.reset();
				return editor;

			})( new THREE.Material() );

		</script>

		<script>
		/*
			//	IMPORTANT !!! IMPORTANT !!! IMPORTANT !!! IMPORTANT !!!
			//	Overwrites THREE.Material.prototype.copy
			//	and MeshStandardMaterial.prototype.copy.

				editor.copy = function( source ){

				//	Overwrite THREE.Material.copy;
				//	THREE.Material.prototype.copy.call( editor, source );

					editor.name = source.name;
					editor.type = source.type;
					editor.uuid = source.uuid;
					editor.side = source.side;

					editor.opacity = source.opacity;
					editor.alphaTest = source.alphaTest;
					editor.transparent = source.transparent;
					editor.premultipliedAlpha = source.premultipliedAlpha;

					editor.fog = source.fog;
					editor.lights = source.lights;
					editor.visible = source.visible;
					editor.overdraw = source.overdraw;
					editor.dithering = source.dithering;
					editor.precision = source.precision;
					editor.colorWrite = source.colorWrite;
					editor.flatShading = source.flatShading;
					editor.vertexColors = source.vertexColors;

					editor.blending = source.blending;
					editor.blendSrc = source.blendSrc;
					editor.blendDst = source.blendDst;
					editor.blendEquation = source.blendEquation;
					editor.blendSrcAlpha = source.blendSrcAlpha;
					editor.blendDstAlpha = source.blendDstAlpha;
					editor.blendEquationAlpha = source.blendEquationAlpha;
					
					editor.depthFunc = source.depthFunc;
					editor.depthTest = source.depthTest;
					editor.depthWrite = source.depthWrite;

					editor.shadowSide = source.shadowSide;
					editor.clipShadows = source.clipShadows;
					editor.clipIntersection = source.clipIntersection;

					editor.polygonOffset = source.polygonOffset;
					editor.polygonOffsetUnits = source.polygonOffsetUnits;
					editor.polygonOffsetFactor = source.polygonOffsetFactor;

					editor.userData = JSON.parse( JSON.stringify( source.userData ) );

					var srcPlanes = source.clippingPlanes,
						dstPlanes = null;

					if ( srcPlanes !== null ) {

						var n = srcPlanes.length;
						dstPlanes = new Array( n );

						for ( var i = 0; i !== n; ++ i )
							dstPlanes[ i ] = srcPlanes[ i ].clone();

					}

					editor.clippingPlanes = dstPlanes;

				//	Overwrite THREE.MeshStandardMaterial.copy;
				//	THREE.MeshStandardMaterial.prototype.copy.call( editor, source );

					editor.defines = { "STANDARD": "" };

					editor.map = source.map;
					editor.aoMap = source.aoMap;
					editor.envMap = source.envMap;
					editor.bumpMap = source.bumpMap;
					editor.alphaMap = source.alphaMap;
					editor.lightMap = source.lightMap;
					editor.normalMap = source.normalMap;
					editor.emissiveMap = source.emissiveMap;
					editor.metalnessMap = source.metalnessMap;
					editor.roughnessMap = source.roughnessMap;
					editor.displacementMap = source.displacementMap;

					editor.metalness = source.metalness;
					editor.roughness = source.roughness;
					editor.bumpScale = source.bumpScale;
					editor.reflectivity = source.reflectivity;
					editor.normalMapType = source.normalMapType;
					editor.refractionRatio = source.refractionRatio;
					editor.displacementBias = source.displacementBias;
					editor.displacementScale = source.displacementScale;
					
					editor.aoMapIntensity = source.aoMapIntensity;
					editor.envMapIntensity = source.envMapIntensity;
					editor.emissiveIntensity = source.emissiveIntensity;
					editor.lightMapIntensity = source.lightMapIntensity;

					editor.wireframe = source.wireframe;
					editor.wireframeLinecap = source.wireframeLinecap;
					editor.wireframeLinejoin = source.wireframeLinejoin;
					editor.wireframeLinewidth = source.wireframeLinewidth;

					editor.skinning = source.skinning;
					editor.morphTargets = source.morphTargets;
					editor.morphNormals = source.morphNormals;

				//	mesh basic,phong,lambert material.

					if ( source.combine !== undefined ) 
						editor.combine = source.combine;
					else delete editor.combine;

					if ( source.shininess !== undefined ) 
						editor.shininess = source.shininess;
					else delete editor.shininess;

					if ( source.specularMap !== undefined ) 
						editor.specularMap = source.specularMap;
					else delete editor.specularMap;

				//	bypass vector.copy() errors.

					try { 
						editor.normalScale && source.normalScale 
						&& editor.normalScale.copy( source.normalScale ); 
					} catch(err){ 
						editor.normalScale && editor.normalScale.set(1,1); 
					}

				//	bypass color.copy() errors.

					try { 
						editor.color && source.color 
						&& editor.color.copy( source.color ); 
					} catch(err){ 
						editor.color && editor.color.setRGB(1,1,1); 
					}

					try { 
						editor.emissive && source.emissive 
						&& editor.emissive.copy( source.emissive ); 
					} catch(err){ 
						editor.emissive && editor.emissive.setRGB(0,0,0); 
					}

					try { 
						if ( editor.specular && source.specular )
							editor.specular.copy( source.specular ); 
						else delete editor.specular;
					} catch(err){ 
						editor.specular && editor.specular.setRGB(0,0,0); 
					}

				//	mesh toon,depth material.
					if ( source.gradientMap !== undefined ) 
						editor.gradientMap = source.gradientMap; // mesh toon material.
					else delete editor.gradientMap;

					if ( source.depthPacking !== undefined ) 
						editor.depthPacking = source.depthPacking; // mesh depth material.
					else delete editor.depthPacking;

				//	line basic,dashed material.
					if ( source.scale !== undefined ) editor.scale = source.scale; else delete editor.scale;
					if ( source.gapSize !== undefined ) editor.gapSize = source.gapSize; else delete editor.gapSize;
					if ( source.linecap !== undefined ) editor.linecap = source.linecap; else delete editor.linecap;
					if ( source.linejoin !== undefined ) editor.linejoin = source.linejoin; else delete editor.linejoin;
					if ( source.linewidth !== undefined ) editor.linewidth = source.linewidth; else delete editor.linewidth;
					if ( source.dashSize !== undefined ) editor.dashSize = source.dashSize; else delete editor.dashSize;

				//	sprite,point material.
					if ( source.size !== undefined ) editor.size = source.size; else delete editor.size;
					if ( source.rotation !== undefined ) editor.rotation = source.rotation; else delete editor.rotation;
					if ( source.sizeAttenuation !== undefined ) editor.sizeAttenuation = source.sizeAttenuation; else delete editor.sizeAttenuation;

				};
		*/
		</script>

		<script>

			localPlayer.controller.movementSpeed = 10;

		//	Entities.

		//	debugMode && (function(){
		//		var r = 1;
		//		var geometry = new THREE.BoxGeometry(r,r,r);
		//		var material = new THREE.MeshLambertMaterial();
		//		var cube = new THREE.Mesh(geometry, material);
		//		cube.name = "local player cube";
		//		var geometry = new THREE.SphereGeometry(0.7,8,12);
		//		var material = new THREE.MeshLambertMaterial();
		//		var sphere = new THREE.Mesh(geometry, material);
		//		sphere.name = "local player sphere";
		//	//	cube.add( sphere );
		//		localPlayer.add( cube );
		//	})();

		//	box coluctions.

			debugMode && (function(){

				var material = new THREE.MeshLambertMaterial({name:"mtl00"});

				(function(){
					var w = 10; var h = 5;
					var box = new THREE.BoxGeometry(w,h,w);
					box.translate(0, h/2, 0);
					octree.importThreeMesh( new THREE.Mesh(box) );
					var geometry = new THREE.EdgesGeometry( box );
					var material = new THREE.LineBasicMaterial( { color: 0x00ff00 } );
					var segments = new THREE.LineSegments( geometry, material );
					segments.name = "segments 1";
					scene.add( segments );
				})();

				(function(){
					var w = 10, h = 20;
					var x = 10, y = h/2, z = -4;
					var box = new THREE.BoxGeometry(w,h,w);
					box.translate(0, h/2, 0);
					var material = new THREE.MeshLambertMaterial();
					var mesh = new THREE.Mesh(box, material);
					mesh.name = "building 1";
					mesh.position.set(x,0,z);
					octree.importThreeMesh( mesh );
					var geometry = new THREE.EdgesGeometry( box );
					var segments = new THREE.LineSegments( geometry, material );
					segments.name = "segments 2";
					segments.position.copy( mesh.position );
					scene.add( mesh );
					cameraControls.rigidObjects.push( mesh );
				})();

				(function(){
					var w = 12, h = 10;
					var x = 15, y = h/2, z = -11;
					var box = new THREE.BoxGeometry(w,h,w);
					box.translate(0, h/2, 0);
					var material = new THREE.MeshLambertMaterial();
					var mesh = new THREE.Mesh(box, material);
					mesh.name = "building 2";
					mesh.position.set(x,0,z);
					octree.importThreeMesh( mesh );
					var geometry = new THREE.EdgesGeometry( box );
					var segments = new THREE.LineSegments( geometry, material );
					segments.name = "segments 3";
					segments.position.copy( mesh.position );
					scene.add( mesh );
					cameraControls.rigidObjects.push( mesh );
				})();

				(function(){
					var w = 8, h = 10;
					var x = -9, y = h/2, z = 5;
					var box = new THREE.BoxGeometry(w,h,w);
					box.translate(0, h/2, 0);
					var material = new THREE.MeshLambertMaterial();
					var mesh = new THREE.Mesh(box, material);
					mesh.name = "building 3";
					mesh.position.set(x,0,z);
					octree.importThreeMesh( mesh );
					var geometry = new THREE.EdgesGeometry( box );
					var segments = new THREE.LineSegments( geometry, material );
					segments.name = "segments 4";
					segments.position.copy( mesh.position );
					scene.add( mesh );
					cameraControls.rigidObjects.push( mesh );
				})();

				(function(){
					var w = 12, h = 20, d = 2;
					var x = -14, y = h/2, z = 10;
					var box = new THREE.BoxGeometry(w,h,d);
					box.translate(0, h/2, 0);
					var material = new THREE.MeshLambertMaterial();
					var mesh = new THREE.Mesh(box, material);
					mesh.name = "building 4";
					mesh.position.set(x,0,z);
					octree.importThreeMesh( mesh );
					var geometry = new THREE.EdgesGeometry( box );
					var segments = new THREE.LineSegments( geometry, material );
					segments.name = "segments 5";
					segments.position.copy( mesh.position );
					scene.add( mesh );
					cameraControls.rigidObjects.push( mesh );
				})();

				(function(){
					var w = 4, h = 20, d = 20;
					var x = -17, y = h/2, z = 12;
					var box = new THREE.BoxGeometry(w,h,d);
					box.translate(0, h/2, 0);
					var material = new THREE.MeshLambertMaterial();
					var mesh = new THREE.Mesh(box, material);
					mesh.name = "building 5";
					mesh.position.set(x,0,z);
					octree.importThreeMesh( mesh );
					var geometry = new THREE.EdgesGeometry( box );
					var segments = new THREE.LineSegments( geometry, material );
					segments.name = "segments 6";
					segments.position.copy( mesh.position );
					scene.add( mesh );
					cameraControls.rigidObjects.push( mesh );
				})();

			//	var groupA = new THREE.Object3D();
			//	var groupB = new THREE.Object3D();

			//	groupA.add( scene.getObjectByName("building 1").clone() );
			//	groupA.add( scene.getObjectByName("building 2").clone() );
			//	groupB.add( scene.getObjectByName("building 3").clone() );
			//	groupB.add( scene.getObjectByName("building 4").clone() );
			//	groupB.add( scene.getObjectByName("building 5").clone() );

			})();

		</script>

		<script>

		//	Add entities.

		//	Add Object3D entities.
			scene.traverse(function( object ){
				entities.add( object );
			});

		//	Add Material entities.
			entities.forEach( function( entity ){

			//	It looks in "entities" manager only.
			//	It looks the root Object3D, but not children.

				var object = scene.getObjectById( entity.id );
				if ( !object.material ) return; // important!

				if ( Array.isArray( object.material ) )
					object.material.forEach( addtoManager );
				else 
					addtoManager( object.material );

				function addtoManager( material ){
					rename( material );
					addEntity( material );
				}

				function rename( material ){
					if ( material.name ) return;
					material.name = "mtl"+material.id;;
				}

				function addEntity( material ){
					var included = material_entities.includes( material );
					debugMode && console.log( "included:", included );
					if ( !included ) material_entities.add( material );
				}
			});

			console.log( {"object3DEditor": object3DEditor} ); // debug!
			console.log( {"materialEditor": materialEditor} ); // debug!

		</script>

	</body>
</html>
